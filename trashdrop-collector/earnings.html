<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Earnings - TrashDrop Collector</title>
    <meta name="description" content="View your earnings and payment history">
    <link rel="stylesheet" href="./src/styles/main.css">
    <link rel="stylesheet" href="./src/styles/navigation.css">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="stylesheet" href="./src/styles/top-nav.css">
    <link rel="stylesheet" href="./src/styles/earnings.css">
    <!-- Material Icons Font -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Core initialization loader - should be loaded first -->
    <script src="./src/js/init-loader.js"></script>
    
    <!-- Dynamic resource loading - replaced hardcoded CDN links -->
    <script type="module">
        import { loadResources } from './src/js/resource-loader.js';
        
        // Wait for core initialization before loading additional resources
        window.addEventListener('coreInitialized', () => {
            // Load all required resources
            window.resourceLoadPromise = loadResources({
                loadSupabase: true,
                loadFonts: true,
                loadChartJs: true
            }).then(() => {
                console.log('‚úÖ All resources loaded successfully');
                window.dispatchEvent(new CustomEvent('resourcesLoaded'));
            }).catch(error => {
                console.error('‚ùå Failed to load resources:', error);
            });
        });
    </script>
    
    <!-- Chart.js Styles -->
    <style>
        /* Chart styles */
        .chart-container {
            margin: 20px 0;
            height: 250px;
            position: relative;
        }
    </style>
    
    <!-- Script Loading and Dependency Management -->
    <script>
        // Track loaded scripts to avoid duplicates
        window.loadedScripts = window.loadedScripts || {};
        
        // Function to load scripts in sequence with better error handling
        function loadScript(src, onLoad, onError) {
            // Skip if already loaded
            if (window.loadedScripts[src]) {
                console.log('üîÅ Script already loaded:', src);
                if (onLoad) setTimeout(onLoad, 0);
                return;
            }
            
            console.log('üì• Loading script:', src);
            const script = document.createElement('script');
            script.src = src;
            script.onload = function() {
                console.log('‚úÖ Loaded script:', src);
                window.loadedScripts[src] = true;
                if (onLoad) setTimeout(onLoad, 0);
            };
            script.onerror = function(e) {
                console.error('‚ùå Error loading script:', src, e);
                if (onError) onError(e);
            };
            document.head.appendChild(script);
            return script;
        }
        
        // Script loading sequence
        console.log('üîÅ Starting script loading sequence for earnings.html...');
        
        // 1. Load config.js first (sets window.CONFIG directly)
        loadScript('./src/js/config.js', function() {
            console.log('üîÅ Config.js loaded callback fired');
            
            // Verify CONFIG is available
            if (!window.CONFIG) {
                console.error('‚ùå CONFIG not available after loading config.js');
            } else {
                console.log('‚úÖ CONFIG loaded successfully');
            }
            
            // 2. Load Supabase SDK with UMD build for global supabase object
            loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js', function() {
                console.log('üîÅ Supabase SDK loaded, window.supabase available:', !!window.supabase);
                
                // 3. Then load our supabase client wrapper
                loadScript('./src/js/supabase-client.js', function() {
                    console.log('üîÅ Supabase client initialized:', !!window.supabaseClient);
                    
                    // 4. Finally load auth.js which depends on supabase client
                    loadScript('./src/js/auth.js', function() {
                        // 5. Load earnings.js after auth and client are ready
                        loadScript('./src/js/earnings.js', function() {
                            console.log('‚úÖ All core scripts loaded for earnings page');
                            // Dispatch event when all core scripts are loaded
                            window.dispatchEvent(new CustomEvent('earningsScriptsLoaded'));
                        });
                    });
                });
            });
        });
    </script>
    
    <!-- Helper functions for script dependencies -->
    <script>
    // Wait for core scripts to be loaded
    function waitForSupabaseClient(callback) {
        if (window.supabaseClient) {
            callback();
        } else {
            window.addEventListener('supabaseClientInitialized', callback);
        }
    }
    
    // Listen for Supabase client initialization
    window.addEventListener('supabaseClientInitialized', function(e) {
        console.log('‚úÖ Supabase client initialized event received in earnings.html');
    });
    </script>
    
    <script>window.chartJsVersion = '3.9.1';</script>
    
    <!-- Console debugging -->
    <script>
        console.log('Earnings page loading...');
        window.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
        });
    </script>
</head>
<body>
    <!-- Top Navigation Bar with Account Dropdown -->
    <div class="top-nav">
        <div class="top-nav-logo">
            <span>TrashDrop</span>
        </div>
        <div class="top-nav-actions">
            <div class="account-dropdown">
                <button class="account-dropdown-btn">
                    <span class="material-icons">person</span>
                    <span class="dropdown-label" id="userDisplayName">Account</span>
                </button>
                <div class="account-dropdown-content">
                    <a href="./account.html" class="dropdown-item">
                        <span class="material-icons">account_circle</span>
                        My Profile
                    </a>
                    <a href="./account.html#settings-tab" class="dropdown-item">
                        <span class="material-icons">settings</span>
                        Settings
                    </a>
                    <a href="./account.html#support-tab" class="dropdown-item">
                        <span class="material-icons">help</span>
                        Support
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item" id="topNavSignOut">
                        <span class="material-icons">logout</span>
                        Sign Out
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-container">
        <header class="page-header">
            <div class="page-header-left">
                <h1>Earnings</h1>
                <div class="period-selector">
                    <button class="period-btn active" data-period="week">Week</button>
                    <button class="period-btn" data-period="month">Month</button>
                    <button class="period-btn" data-period="year">Year</button>
                </div>
            </div>
            <button id="cashOutBtn" class="btn btn-primary">
                <span class="material-icons">account_balance_wallet</span>
                Cash Out
            </button>
        </header>
        
        <main class="page-content">
            <div class="stats-card">
                <div class="stat-item">
                    <div class="stat-label">Total Earnings</div>
                    <div class="stat-value">‚Çµ0.00</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Completed Jobs</div>
                    <div class="stat-value">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Avg. Per Job</div>
                    <div class="stat-value">‚Çµ0.00</div>
                </div>
            </div>
            
            <div class="content-card">
                <h2>Earnings Overview</h2>
                <div class="chart-container">
                    <canvas id="earningsChart"></canvas>
                </div>
            </div>
            
            <div class="breakdown-row">
                <div class="content-card">
                    <h2>Work Type Breakdown</h2>
                    <div class="breakdown-visualization">
                        <div class="pie-chart-container">
                            <canvas id="workTypeChart"></canvas>
                        </div>
                        <div class="breakdown-list" id="workTypeBreakdown">
                            <p class="empty-state">
                                No work type data available
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="content-card">
                    <h2>Trash Type Breakdown</h2>
                    <div class="breakdown-visualization">
                        <div class="bar-chart-container">
                            <canvas id="trashTypeChart"></canvas>
                        </div>
                        <div class="trash-type-grid" id="trashTypeBreakdown">
                            <!-- Grid items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-card">
                <div class="card-header-with-action">
                    <h2>Recent Payments</h2>
                    <button class="btn btn-text" id="viewAllBtn">
                        <span>View All</span>
                        <span class="material-icons">arrow_forward</span>
                    </button>
                </div>
                <div class="payments-list" id="recentPayments">
                    <p class="empty-state">
                        <span>No payment history available yet</span>
                    </p>
                </div>
            </div>
            
            <div class="content-card">
                <h2>Payment Methods</h2>
                <div class="payment-methods" id="paymentMethods">
                    <div class="payment-method-item">
                        <div class="payment-method-icon">
                            <span class="material-icons">account_balance</span>
                        </div>
                        <div class="payment-method-details">
                            <div class="payment-method-title">Add Payment Method</div>
                            <div class="payment-method-subtitle">Set up your preferred payment methods</div>
                        </div>
                        <div class="payment-method-action">
                            <button class="btn btn-icon">
                                <span class="material-icons">add_circle</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Bottom Navigation Bar -->
    <div class="bottom-nav">
        <!-- This will be populated by bottom-nav.js -->
    </div>
    
    <!-- Load the new bottom navigation component -->
    <script src="./src/js/bottom-nav.js"></script>
    
    <!-- Cash Out Modal -->
    <div class="modal" id="cashOutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Cash Out Earnings</h2>
                <button class="close-modal">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="cash-out-info">
                    <div class="cash-out-balance">
                        <div class="balance-label">Available Balance</div>
                        <div class="balance-value" id="availableBalance">‚Çµ3,856.50</div>
                    </div>
                    <div class="cash-out-form">
                        <div class="form-group">
                            <label for="cashOutAmount">Amount to Withdraw (‚Çµ)</label>
                            <input type="number" id="cashOutAmount" class="form-control" min="0" max="3856.50" step="0.01" placeholder="Enter amount">
                            <div class="form-feedback" id="amountFeedback"></div>
                        </div>
                        <div class="form-group">
                            <label for="cashOutMethod">Payment Method</label>
                            <select id="cashOutMethod" class="form-control">
                                <option value="bank">Bank Transfer</option>
                                <option value="mobile">Mobile Money</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Cancel</button>
                <button class="btn btn-primary" id="confirmCashOutBtn">Confirm Withdrawal</button>
            </div>
        </div>
    </div>
    
    <!-- Processing Modal -->
    <div class="modal" id="processingModal">
        <div class="modal-content modal-sm">
            <div class="modal-body text-center">
                <div class="loading-spinner"></div>
                <h3>Processing Your Withdrawal</h3>
                <p>Please wait while we process your request...</p>
            </div>
        </div>
    </div>
    
    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content modal-sm">
            <div class="modal-body text-center">
                <div class="success-icon">
                    <span class="material-icons">check_circle</span>
                </div>
                <h3>Withdrawal Successful!</h3>
                <p>Your withdrawal request for <span id="withdrawalAmount"></span> has been processed successfully.</p>
                <p class="text-muted">You will be redirected to the payment gateway...</p>
                <div class="modal-footer">
                    <button class="btn btn-primary btn-block" id="successOkBtn">Continue</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Immediate Mock Data Display -->
    <script>
        // Direct mock data implementation for immediate display
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Directly updating UI with mock data');
            
            // Update stats
            const statValues = document.querySelectorAll('.stat-value');
            if (statValues.length >= 3) {
                statValues[0].textContent = '‚Çµ3,856.50';
                statValues[1].textContent = '78';
                statValues[2].textContent = '‚Çµ49.44';
            }
            
            // Update work type breakdown
            const workTypeBreakdown = document.getElementById('workTypeBreakdown');
            if (workTypeBreakdown) {
                workTypeBreakdown.innerHTML = `
                    <div class="breakdown-item">
                        <div class="breakdown-item-title">Assignments</div>
                        <div class="breakdown-item-stats">
                            <span class="breakdown-item-count">45 jobs</span>
                            <span class="breakdown-item-amount">‚Çµ2,150.75</span>
                        </div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-item-title">Pickups</div>
                        <div class="breakdown-item-stats">
                            <span class="breakdown-item-count">33 jobs</span>
                            <span class="breakdown-item-amount">‚Çµ1,705.75</span>
                        </div>
                    </div>
                `;
            }
            
            // Update trash type breakdown
            const trashTypeBreakdown = document.getElementById('trashTypeBreakdown');
            if (trashTypeBreakdown) {
                trashTypeBreakdown.innerHTML = `
                    <div class="breakdown-item">
                        <div class="breakdown-item-title">Plastic</div>
                        <div class="breakdown-item-stats">
                            <span class="breakdown-item-count">28 jobs</span>
                            <span class="breakdown-item-amount">‚Çµ1,400.00</span>
                        </div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-item-title">Paper</div>
                        <div class="breakdown-item-stats">
                            <span class="breakdown-item-count">16 jobs</span>
                            <span class="breakdown-item-amount">‚Çµ800.50</span>
                        </div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-item-title">Glass</div>
                        <div class="breakdown-item-stats">
                            <span class="breakdown-item-count">12 jobs</span>
                            <span class="breakdown-item-amount">‚Çµ720.00</span>
                        </div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-item-title">Metal</div>
                        <div class="breakdown-item-stats">
                            <span class="breakdown-item-count">14 jobs</span>
                            <span class="breakdown-item-amount">‚Çµ686.00</span>
                        </div>
                    </div>
                    <div class="breakdown-item">
                        <div class="breakdown-item-title">Organic</div>
                        <div class="breakdown-item-stats">
                            <span class="breakdown-item-count">8 jobs</span>
                            <span class="breakdown-item-amount">‚Çµ250.00</span>
                        </div>
                    </div>
                `;
            }
            
            // Update recent payments
            const recentPayments = document.getElementById('recentPayments');
            if (recentPayments) {
                recentPayments.innerHTML = `
                    <div class="payment-item">
                        <div class="payment-info">
                            <div class="payment-date">${new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toLocaleDateString()}</div>
                            <div class="payment-method">Bank Transfer</div>
                        </div>
                        <div class="payment-amount">‚Çµ1,250.00</div>
                    </div>
                    <div class="payment-item">
                        <div class="payment-info">
                            <div class="payment-date">${new Date(Date.now() - 9 * 24 * 60 * 60 * 1000).toLocaleDateString()}</div>
                            <div class="payment-method">Mobile Money</div>
                        </div>
                        <div class="payment-amount">‚Çµ800.50</div>
                    </div>
                    <div class="payment-item">
                        <div class="payment-info">
                            <div class="payment-date">${new Date(Date.now() - 16 * 24 * 60 * 60 * 1000).toLocaleDateString()}</div>
                            <div class="payment-method">Bank Transfer</div>
                        </div>
                        <div class="payment-amount">‚Çµ950.25</div>
                    </div>
                `;
            }
            
            // Initialize line chart for earnings overview
            const earningsCtx = document.getElementById('earningsChart');
            if (earningsCtx && window.Chart) {
                const chartData = {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Earnings (‚Çµ)',
                        data: [425.50, 380.25, 520.75, 0, 680.00, 750.50, 1099.50],
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        borderColor: '#4CAF50',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true
                    }]
                };
                
                const config = {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‚Çµ' + value.toFixed(2);
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `‚Çµ${context.raw.toFixed(2)}`;
                                    }
                                }
                            }
                        }
                    }
                };
                
                new Chart(earningsCtx, config);
            }
            
            // Initialize pie chart for work type breakdown
            const workTypeCtx = document.getElementById('workTypeChart');
            if (workTypeCtx && window.Chart) {
                const workTypeData = {
                    labels: ['Assignments', 'Pickups'],
                    datasets: [{
                        data: [2150.75, 1705.75],
                        backgroundColor: [
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(33, 150, 243, 0.8)'
                        ],
                        borderColor: [
                            '#4CAF50',
                            '#2196F3'
                        ],
                        borderWidth: 1,
                        hoverOffset: 15
                    }]
                };
                
                const workTypeConfig = {
                    type: 'doughnut',
                    data: workTypeData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = Math.round((value / total) * 100);
                                        return `${label}: ‚Çµ${value.toFixed(2)} (${percentage}%)`;
                                    }
                                }
                            }
                        },
                        cutout: '65%',
                        animation: {
                            animateScale: true,
                            animateRotate: true
                        }
                    }
                };
                
                new Chart(workTypeCtx, workTypeConfig);
            }
            
            // Initialize bar chart for trash type breakdown
            const trashTypeCtx = document.getElementById('trashTypeChart');
            if (trashTypeCtx && window.Chart) {
                const trashTypeData = {
                    labels: ['Plastic', 'Paper', 'Glass', 'Metal', 'Organic'],
                    datasets: [{
                        label: 'Earnings (‚Çµ)',
                        data: [1400.00, 800.50, 720.00, 686.00, 250.00],
                        backgroundColor: [
                            'rgba(255, 87, 34, 0.7)',  // Red-orange for plastic
                            'rgba(139, 195, 74, 0.7)', // Light green for paper
                            'rgba(33, 150, 243, 0.7)', // Blue for glass
                            'rgba(158, 158, 158, 0.7)', // Grey for metal
                            'rgba(121, 85, 72, 0.7)'   // Brown for organic
                        ],
                        borderColor: [
                            'rgb(255, 87, 34)',
                            'rgb(139, 195, 74)',
                            'rgb(33, 150, 243)',
                            'rgb(158, 158, 158)',
                            'rgb(121, 85, 72)'
                        ],
                        borderWidth: 1,
                        borderRadius: 5,
                        barPercentage: 0.6
                    }]
                };
                
                const trashTypeConfig = {
                    type: 'bar',
                    data: trashTypeData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `‚Çµ${context.raw.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '‚Çµ' + value.toFixed(0);
                                    }
                                }
                            }
                        },
                        animation: {
                            animateScale: true
                        }
                    }
                };
                
                new Chart(trashTypeCtx, trashTypeConfig);
                
                // Add trash type grid items
                const trashTypeBreakdown = document.getElementById('trashTypeBreakdown');
                if (trashTypeBreakdown) {
                    trashTypeBreakdown.innerHTML = ''; // Clear any existing content
                    
                    // Create a grid item for each trash type
                    const trashTypes = [
                        { type: 'Plastic', amount: 1400.00, color: 'rgb(255, 87, 34)', percentage: '36.3%' },
                        { type: 'Paper', amount: 800.50, color: 'rgb(139, 195, 74)', percentage: '20.8%' },
                        { type: 'Glass', amount: 720.00, color: 'rgb(33, 150, 243)', percentage: '18.7%' },
                        { type: 'Metal', amount: 686.00, color: 'rgb(158, 158, 158)', percentage: '17.8%' },
                        { type: 'Organic', amount: 250.00, color: 'rgb(121, 85, 72)', percentage: '6.5%' }
                    ];
                    
                    trashTypes.forEach(item => {
                        const gridItem = document.createElement('div');
                        gridItem.className = 'trash-type-item';
                        gridItem.innerHTML = `
                            <div class="trash-type-color" style="background-color: ${item.color}"></div>
                            <div class="trash-type-name">${item.type} <span style="font-size: 0.8rem; color: var(--medium); font-weight: normal;">${item.percentage}</span></div>
                            <div class="trash-type-value">‚Çµ${item.amount.toFixed(2)}</div>
                        `;
                        trashTypeBreakdown.appendChild(gridItem);
                    });
                }
            }
            
            // Add payment methods
            const paymentMethods = document.getElementById('paymentMethods');
            if (paymentMethods) {
                paymentMethods.innerHTML = `
                    <div class="payment-method-item">
                        <div class="payment-method-icon">
                            <span class="material-icons">account_balance</span>
                        </div>
                        <div class="payment-method-details">
                            <div class="payment-method-title">Bank Account</div>
                            <div class="payment-method-subtitle">Ending in 4325</div>
                        </div>
                        <div class="payment-method-action">
                            <button class="btn btn-icon" id="editBankBtn">
                                <span class="material-icons">edit</span>
                            </button>
                        </div>
                    </div>
                    <div class="payment-method-item">
                        <div class="payment-method-icon">
                            <span class="material-icons">smartphone</span>
                        </div>
                        <div class="payment-method-details">
                            <div class="payment-method-title">Mobile Money</div>
                            <div class="payment-method-subtitle">+233 55 123 4567</div>
                        </div>
                        <div class="payment-method-action">
                            <button class="btn btn-icon" id="editMobileBtn">
                                <span class="material-icons">edit</span>
                            </button>
                        </div>
                    </div>
                    <div class="payment-method-item">
                        <div class="payment-method-icon">
                            <span class="material-icons">add_circle</span>
                        </div>
                        <div class="payment-method-details">
                            <div class="payment-method-title">Add Payment Method</div>
                            <div class="payment-method-subtitle">Set up your preferred payment methods</div>
                        </div>
                        <div class="payment-method-action">
                            <button class="btn btn-icon" id="addPaymentMethodBtn">
                                <span class="material-icons">arrow_forward</span>
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listeners to the payment method buttons
                document.getElementById('editBankBtn').addEventListener('click', function() {
                    // Create and show bank edit modal
                    const modalHtml = `
                        <div class="modal" id="editBankModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2>Edit Bank Account</h2>
                                    <button class="close-modal">
                                        <span class="material-icons">close</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form id="editBankForm">
                                        <div class="form-group">
                                            <label for="bankName">Bank Name</label>
                                            <input type="text" id="bankName" class="form-control" value="Ghana Commercial Bank" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="accountNumber">Account Number</label>
                                            <input type="text" id="accountNumber" class="form-control" value="XXXX-XXXX-4325" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="accountType">Account Type</label>
                                            <select id="accountType" class="form-control">
                                                <option value="checking" selected>Checking</option>
                                                <option value="savings">Savings</option>
                                                <option value="current">Current</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="branchName">Branch Name</label>
                                            <input type="text" id="branchName" class="form-control" value="Accra Main Branch">
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary close-modal">Cancel</button>
                                    <button class="btn btn-primary" id="saveBankBtn">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Append modal to body if it doesn't exist
                    if (!document.getElementById('editBankModal')) {
                        const modalContainer = document.createElement('div');
                        modalContainer.innerHTML = modalHtml;
                        document.body.appendChild(modalContainer.firstElementChild);
                        
                        // Set up close button
                        document.querySelector('#editBankModal .close-modal').addEventListener('click', function() {
                            document.getElementById('editBankModal').classList.remove('active');
                        });
                        
                        // Set up save button
                        document.getElementById('saveBankBtn').addEventListener('click', function() {
                            document.getElementById('editBankModal').classList.remove('active');
                            alert('Bank account information updated successfully');
                        });
                    }
                    
                    // Show the modal
                    document.getElementById('editBankModal').classList.add('active');
                });
                
                document.getElementById('editMobileBtn').addEventListener('click', function() {
                    // Create and show mobile money edit modal
                    const modalHtml = `
                        <div class="modal" id="editMobileModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2>Edit Mobile Money</h2>
                                    <button class="close-modal">
                                        <span class="material-icons">close</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <form id="editMobileForm">
                                        <div class="form-group">
                                            <label for="mobileProvider">Provider</label>
                                            <select id="mobileProvider" class="form-control">
                                                <option value="mtn" selected>MTN Mobile Money</option>
                                                <option value="vodafone">Vodafone Cash</option>
                                                <option value="airtel">AirtelTigo Money</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="mobileNumber">Mobile Number</label>
                                            <input type="tel" id="mobileNumber" class="form-control" value="+233 55 123 4567" required>
                                            <div class="form-hint">Format: +233 XX XXX XXXX</div>
                                        </div>
                                        <div class="form-group">
                                            <label for="accountName">Account Name</label>
                                            <input type="text" id="accountName" class="form-control" value="John Doe" required>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary close-modal">Cancel</button>
                                    <button class="btn btn-primary" id="saveMobileBtn">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Append modal to body if it doesn't exist
                    if (!document.getElementById('editMobileModal')) {
                        const modalContainer = document.createElement('div');
                        modalContainer.innerHTML = modalHtml;
                        document.body.appendChild(modalContainer.firstElementChild);
                        
                        // Set up close button
                        document.querySelector('#editMobileModal .close-modal').addEventListener('click', function() {
                            document.getElementById('editMobileModal').classList.remove('active');
                        });
                        
                        // Set up save button
                        document.getElementById('saveMobileBtn').addEventListener('click', function() {
                            document.getElementById('editMobileModal').classList.remove('active');
                            alert('Mobile money information updated successfully');
                        });
                    }
                    
                    // Show the modal
                    document.getElementById('editMobileModal').classList.add('active');
                });
                
                document.getElementById('addPaymentMethodBtn').addEventListener('click', function() {
                    // Create and show add payment method modal
                    const modalHtml = `
                        <div class="modal" id="addPaymentMethodModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2>Add Payment Method</h2>
                                    <button class="close-modal">
                                        <span class="material-icons">close</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="payment-method-options">
                                        <div class="payment-method-option" data-type="bank">
                                            <div class="payment-method-icon">
                                                <span class="material-icons">account_balance</span>
                                            </div>
                                            <div class="payment-method-label">Bank Account</div>
                                        </div>
                                        <div class="payment-method-option" data-type="mobile">
                                            <div class="payment-method-icon">
                                                <span class="material-icons">smartphone</span>
                                            </div>
                                            <div class="payment-method-label">Mobile Money</div>
                                        </div>
                                        <div class="payment-method-option" data-type="card">
                                            <div class="payment-method-icon">
                                                <span class="material-icons">credit_card</span>
                                            </div>
                                            <div class="payment-method-label">Credit/Debit Card</div>
                                        </div>
                                    </div>
                                    <div id="paymentMethodForms">
                                        <div id="bankForm" class="payment-form">
                                            <h3>Add Bank Account</h3>
                                            <form>
                                                <div class="form-group">
                                                    <label for="newBankName">Bank Name</label>
                                                    <input type="text" id="newBankName" class="form-control" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="newAccountNumber">Account Number</label>
                                                    <input type="text" id="newAccountNumber" class="form-control" required>
                                                </div>
                                                <div class="form-group">
                                                    <label for="newAccountType">Account Type</label>
                                                    <select id="newAccountType" class="form-control">
                                                        <option value="checking">Checking</option>
                                                        <option value="savings">Savings</option>
                                                        <option value="current">Current</option>
                                                    </select>
                                                </div>
                                                <div class="form-group">
                                                    <label for="newBranchName">Branch Name</label>
                                                    <input type="text" id="newBranchName" class="form-control">
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-secondary close-modal">Cancel</button>
                                    <button class="btn btn-primary" id="addPaymentMethodConfirmBtn">Add Payment Method</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Append modal to body if it doesn't exist
                    if (!document.getElementById('addPaymentMethodModal')) {
                        const modalContainer = document.createElement('div');
                        modalContainer.innerHTML = modalHtml;
                        document.body.appendChild(modalContainer.firstElementChild);
                        
                        // Set up close button
                        document.querySelector('#addPaymentMethodModal .close-modal').addEventListener('click', function() {
                            document.getElementById('addPaymentMethodModal').classList.remove('active');
                        });
                        
                        // Set up payment method option selection
                        const paymentMethodOptions = document.querySelectorAll('.payment-method-option');
                        paymentMethodOptions.forEach(option => {
                            option.addEventListener('click', function() {
                                // Remove active class from all options
                                paymentMethodOptions.forEach(opt => opt.classList.remove('active'));
                                
                                // Add active class to clicked option
                                this.classList.add('active');
                                
                                // Show corresponding form
                                const type = this.getAttribute('data-type');
                                const forms = document.querySelectorAll('.payment-form');
                                forms.forEach(form => form.style.display = 'none');
                                document.getElementById(`${type}Form`).style.display = 'block';
                            });
                        });
                        
                        // Set first option as active by default
                        paymentMethodOptions[0].click();
                        
                        // Set up add button
                        document.getElementById('addPaymentMethodConfirmBtn').addEventListener('click', function() {
                            document.getElementById('addPaymentMethodModal').classList.remove('active');
                            alert('New payment method added successfully');
                        });
                    }
                    
                    // Show the modal
                    document.getElementById('addPaymentMethodModal').classList.add('active');
                });
            }
            
            // Set up Cash Out button functionality
            const cashOutBtn = document.getElementById('cashOutBtn');
            if (cashOutBtn) {
                cashOutBtn.addEventListener('click', function() {
                    const cashOutModal = document.getElementById('cashOutModal');
                    if (cashOutModal) {
                        cashOutModal.classList.add('active');
                    }
                });
            }
            
            // Set up close modal buttons
            const closeModalBtns = document.querySelectorAll('.close-modal');
            closeModalBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal) {
                        modal.classList.remove('active');
                    }
                });
            });
            
            // Set up cash out amount validation
            const cashOutAmount = document.getElementById('cashOutAmount');
            const amountFeedback = document.getElementById('amountFeedback');
            if (cashOutAmount && amountFeedback) {
                cashOutAmount.addEventListener('input', function() {
                    const amount = parseFloat(this.value);
                    const maxAmount = 3856.50;
                    
                    if (isNaN(amount) || amount <= 0) {
                        amountFeedback.textContent = 'Please enter a valid amount';
                        amountFeedback.className = 'form-feedback error';
                        this.setCustomValidity('Invalid amount');
                    } else if (amount > maxAmount) {
                        amountFeedback.textContent = 'Amount exceeds available balance';
                        amountFeedback.className = 'form-feedback error';
                        this.setCustomValidity('Amount exceeds available balance');
                    } else {
                        amountFeedback.textContent = 'Amount is valid';
                        amountFeedback.className = 'form-feedback success';
                        this.setCustomValidity('');
                    }
                });
            }
            
            // Set up confirm cash out button
            const confirmCashOutBtn = document.getElementById('confirmCashOutBtn');
            if (confirmCashOutBtn) {
                confirmCashOutBtn.addEventListener('click', function() {
                    const amount = parseFloat(document.getElementById('cashOutAmount').value);
                    const maxAmount = 3856.50;
                    
                    if (isNaN(amount) || amount <= 0 || amount > maxAmount) {
                        return; // Don't proceed if the amount is invalid
                    }
                    
                    // Hide cash out modal
                    document.getElementById('cashOutModal').classList.remove('active');
                    
                    // Show processing modal
                    document.getElementById('processingModal').classList.add('active');
                    
                    // Simulate processing
                    setTimeout(function() {
                        // Hide processing modal
                        document.getElementById('processingModal').classList.remove('active');
                        
                        // Set withdrawal amount in success modal
                        document.getElementById('withdrawalAmount').textContent = `‚Çµ${amount.toFixed(2)}`;
                        
                        // Show success modal
                        document.getElementById('successModal').classList.add('active');
                    }, 2000);
                });
            }
            
            // Set up success OK button
            const successOkBtn = document.getElementById('successOkBtn');
            if (successOkBtn) {
                successOkBtn.addEventListener('click', function() {
                    // Hide success modal
                    document.getElementById('successModal').classList.remove('active');
                    
                    // Simulate redirect to payment gateway
                    alert('Redirecting to payment gateway...');
                });
            }
            
            // Set up view all payments button
            const viewAllBtn = document.getElementById('viewAllBtn');
            if (viewAllBtn) {
                viewAllBtn.addEventListener('click', function() {
                    // Create and show payment history modal
                    const modalHtml = `
                        <div class="modal" id="paymentHistoryModal">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h2>Payment History</h2>
                                    <button class="close-modal">
                                        <span class="material-icons">close</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="filter-controls">
                                        <div class="form-group">
                                            <label for="dateFilter">Filter by Date</label>
                                            <select id="dateFilter" class="form-control">
                                                <option value="all">All Time</option>
                                                <option value="month">This Month</option>
                                                <option value="quarter">Last 3 Months</option>
                                                <option value="year">This Year</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="payment-history-list">
                                        <div class="payment-history-item">
                                            <div class="payment-history-date">May 26, 2025</div>
                                            <div class="payment-history-details">
                                                <div class="payment-history-type">Bank Transfer</div>
                                                <div class="payment-history-amount">‚Çµ1,250.00</div>
                                                <div class="payment-history-status completed">Completed</div>
                                            </div>
                                        </div>
                                        <div class="payment-history-item">
                                            <div class="payment-history-date">May 19, 2025</div>
                                            <div class="payment-history-details">
                                                <div class="payment-history-type">Mobile Money</div>
                                                <div class="payment-history-amount">‚Çµ800.50</div>
                                                <div class="payment-history-status completed">Completed</div>
                                            </div>
                                        </div>
                                        <div class="payment-history-item">
                                            <div class="payment-history-date">May 12, 2025</div>
                                            <div class="payment-history-details">
                                                <div class="payment-history-type">Bank Transfer</div>
                                                <div class="payment-history-amount">‚Çµ950.25</div>
                                                <div class="payment-history-status completed">Completed</div>
                                            </div>
                                        </div>
                                        <div class="payment-history-item">
                                            <div class="payment-history-date">May 5, 2025</div>
                                            <div class="payment-history-details">
                                                <div class="payment-history-type">Mobile Money</div>
                                                <div class="payment-history-amount">‚Çµ725.80</div>
                                                <div class="payment-history-status completed">Completed</div>
                                            </div>
                                        </div>
                                        <div class="payment-history-item">
                                            <div class="payment-history-date">April 28, 2025</div>
                                            <div class="payment-history-details">
                                                <div class="payment-history-type">Bank Transfer</div>
                                                <div class="payment-history-amount">‚Çµ500.00</div>
                                                <div class="payment-history-status completed">Completed</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button class="btn btn-primary" id="downloadHistoryBtn">Download History</button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Append modal to body if it doesn't exist
                    if (!document.getElementById('paymentHistoryModal')) {
                        const modalContainer = document.createElement('div');
                        modalContainer.innerHTML = modalHtml;
                        document.body.appendChild(modalContainer.firstElementChild);
                        
                        // Set up close button
                        document.querySelector('#paymentHistoryModal .close-modal').addEventListener('click', function() {
                            document.getElementById('paymentHistoryModal').classList.remove('active');
                        });
                        
                        // Set up download button
                        document.getElementById('downloadHistoryBtn').addEventListener('click', function() {
                            alert('Payment history downloaded successfully');
                        });
                        
                        // Set up date filter
                        document.getElementById('dateFilter').addEventListener('change', function() {
                            alert(`Filtered history by: ${this.options[this.selectedIndex].text}`);
                        });
                    }
                    
                    // Show the modal
                    document.getElementById('paymentHistoryModal').classList.add('active');
                });
            }
            
            // Set up period buttons
            const periodBtns = document.querySelectorAll('.period-btn');
            periodBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Remove active class from all buttons
                    periodBtns.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked button
                    this.classList.add('active');
                    
                    // Update data based on selected period
                    const period = this.textContent.toLowerCase();
                    
                    // Update chart data for the selected period
                    const earningsCtx = document.getElementById('earningsChart');
                    if (earningsCtx && window.Chart) {
                        const chart = Chart.getChart(earningsCtx);
                        if (chart) {
                            let labels, data;
                            
                            switch(period) {
                                case 'week':
                                    labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                                    data = [425.50, 380.25, 520.75, 0, 680.00, 750.50, 1099.50];
                                    break;
                                case 'month':
                                    labels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
                                    data = [980.25, 1250.75, 850.50, 775.00];
                                    break;
                                case 'year':
                                    labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                    data = [250.50, 320.25, 420.75, 580.00, 680.25, 750.50, 0, 0, 0, 0, 350.25, 504.00];
                                    break;
                            }
                            
                            chart.data.labels = labels;
                            chart.data.datasets[0].data = data;
                            chart.update();
                        }
                    }
                    
                    // Update stats based on period
                    const statValues = document.querySelectorAll('.stat-value');
                    if (statValues.length >= 3) {
                        switch(period) {
                            case 'week':
                                statValues[0].textContent = '‚Çµ3,856.50';
                                statValues[1].textContent = '78';
                                statValues[2].textContent = '‚Çµ49.44';
                                break;
                            case 'month':
                                statValues[0].textContent = '‚Çµ14,250.75';
                                statValues[1].textContent = '247';
                                statValues[2].textContent = '‚Çµ57.69';
                                break;
                            case 'year':
                                statValues[0].textContent = '‚Çµ95,420.50';
                                statValues[1].textContent = '1,485';
                                statValues[2].textContent = '‚Çµ64.26';
                                break;
                        }
                    }
                    
                    // Update work type breakdown for the selected period
                    const workTypeCtx = document.getElementById('workTypeChart');
                    if (workTypeCtx && window.Chart) {
                        const chart = Chart.getChart(workTypeCtx);
                        if (chart) {
                            let data;
                            
                            switch(period) {
                                case 'week':
                                    data = [2150.75, 1705.75];
                                    break;
                                case 'month':
                                    data = [8250.75, 6000.00];
                                    break;
                                case 'year':
                                    data = [54250.50, 41170.00];
                                    break;
                            }
                            
                            chart.data.datasets[0].data = data;
                            chart.update();
                        }
                    }
                    
                    // Update trash type breakdown for the selected period
                    const trashTypeCtx = document.getElementById('trashTypeChart');
                    if (trashTypeCtx && window.Chart) {
                        const chart = Chart.getChart(trashTypeCtx);
                        if (chart) {
                            let data;
                            let trashTypes;
                            
                            switch(period) {
                                case 'week':
                                    data = [1400.00, 800.50, 720.00, 686.00, 250.00];
                                    trashTypes = [
                                        { type: 'Plastic', amount: 1400.00, color: 'rgb(255, 87, 34)', percentage: '36.3%' },
                                        { type: 'Paper', amount: 800.50, color: 'rgb(139, 195, 74)', percentage: '20.8%' },
                                        { type: 'Glass', amount: 720.00, color: 'rgb(33, 150, 243)', percentage: '18.7%' },
                                        { type: 'Metal', amount: 686.00, color: 'rgb(158, 158, 158)', percentage: '17.8%' },
                                        { type: 'Organic', amount: 250.00, color: 'rgb(121, 85, 72)', percentage: '6.5%' }
                                    ];
                                    break;
                                case 'month':
                                    data = [4200.00, 3200.75, 2880.00, 2470.00, 1500.00];
                                    trashTypes = [
                                        { type: 'Plastic', amount: 4200.00, color: 'rgb(255, 87, 34)', percentage: '29.5%' },
                                        { type: 'Paper', amount: 3200.75, color: 'rgb(139, 195, 74)', percentage: '22.5%' },
                                        { type: 'Glass', amount: 2880.00, color: 'rgb(33, 150, 243)', percentage: '20.2%' },
                                        { type: 'Metal', amount: 2470.00, color: 'rgb(158, 158, 158)', percentage: '17.3%' },
                                        { type: 'Organic', amount: 1500.00, color: 'rgb(121, 85, 72)', percentage: '10.5%' }
                                    ];
                                    break;
                                case 'year':
                                    data = [28000.50, 22500.75, 18720.00, 15400.00, 10800.25];
                                    trashTypes = [
                                        { type: 'Plastic', amount: 28000.50, color: 'rgb(255, 87, 34)', percentage: '29.3%' },
                                        { type: 'Paper', amount: 22500.75, color: 'rgb(139, 195, 74)', percentage: '23.6%' },
                                        { type: 'Glass', amount: 18720.00, color: 'rgb(33, 150, 243)', percentage: '19.6%' },
                                        { type: 'Metal', amount: 15400.00, color: 'rgb(158, 158, 158)', percentage: '16.1%' },
                                        { type: 'Organic', amount: 10800.25, color: 'rgb(121, 85, 72)', percentage: '11.3%' }
                                    ];
                                    break;
                            }
                            
                            // Update chart
                            chart.data.datasets[0].data = data;
                            chart.update();
                            
                            // Update trash type grid
                            const trashTypeBreakdown = document.getElementById('trashTypeBreakdown');
                            if (trashTypeBreakdown && trashTypes) {
                                trashTypeBreakdown.innerHTML = ''; // Clear existing content
                                
                                // Add new grid items
                                trashTypes.forEach(item => {
                                    const gridItem = document.createElement('div');
                                    gridItem.className = 'trash-type-item';
                                    gridItem.innerHTML = `
                                        <div class="trash-type-color" style="background-color: ${item.color}"></div>
                                        <div class="trash-type-name">${item.type} <span style="font-size: 0.8rem; color: var(--medium); font-weight: normal;">${item.percentage}</span></div>
                                        <div class="trash-type-value">‚Çµ${item.amount.toFixed(2)}</div>
                                    `;
                                    trashTypeBreakdown.appendChild(gridItem);
                                });
                            }
                        }
                    }
                });
            });
        });
    </script>
    
    <!-- Top Navigation JavaScript -->
    <script src="./src/js/top-nav.js"></script>
    
    <!-- Authentication fallback system -->
    <script src="./src/js/auth-fallback.js"></script>
    
    <!-- Earnings JS - Added at the end of body for initialization -->
    <script src="./src/js/earnings.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Handle top navigation sign out
            const topNavSignOut = document.getElementById('topNavSignOut');
            if (topNavSignOut) {
                topNavSignOut.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        await signOut();
                        window.location.href = './login.html';
                    } catch (error) {
                        console.error('Error signing out:', error);
                        // Show notification if available
                        if (typeof showNotification === 'function') {
                            showNotification('Error signing out. Please try again.', 'error');
                        }
                    }
                });
            }
        });
    </script>
</body>
</html>
