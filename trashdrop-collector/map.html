<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>TrashDrop Collector - Map</title>
    <style>
        /* Hide zoom controls on mobile with important flag and multiple selectors for maximum specificity */
        @media (max-width: 968px) {
            .leaflet-control-zoom,
            .leaflet-control-zoom-in,
            .leaflet-control-zoom-out,
            .leaflet-bar a {
                display: none !important;
                visibility: hidden !important;
                opacity: 0 !important;
                pointer-events: none !important;
            }
        }
    </style>
    <title>Map - TrashDrop Collector</title>
    <meta name="description" content="TrashDrop Collector map view">
    <link rel="stylesheet" href="./src/styles/main.css">
    <link rel="stylesheet" href="./src/styles/navigation.css">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="stylesheet" href="./src/styles/top-nav.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tX/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
            
    <!-- Leaflet Locate Control CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol@0.76.1/dist/L.Control.Locate.min.css" />
    
    <!-- Leaflet Locate Control JavaScript -->
    <script src="https://unpkg.com/leaflet.locatecontrol@0.76.1/dist/L.Control.Locate.min.js"></script>
    
    <!-- Simple geolocation fallback -->
    <script>
    // Simple geolocation fallback
    if (!L.control || !L.control.locate) {
        console.warn('Leaflet.locatecontrol not available, using fallback');
        L.control = L.control || {};
        L.control.locate = function(options) {
            return {
                addTo: function() {
                    console.log('Locate control not available');
                    return this;
                }
            };
        };
    }
    </script>
    
    <!-- Fix for navigation labels -->
    <style>
        /* Full reset of navigation styles to ensure labels show */
        .bottom-nav a.nav-item div,
        .bottom-nav a.nav-item span {
            display: block !important;
            visibility: visible !important;
            font-size: 0.7rem !important;
            color: inherit !important;
            margin-top: 0.25rem !important;
            text-align: center !important;
            width: 100% !important;
            opacity: 1 !important;
        }
        
        .bottom-nav a.nav-item i.material-icons,
        .bottom-nav a.nav-item span.material-icons {
            font-size: 1.5rem !important;
            margin-bottom: 0.25rem !important;
            display: block !important;
        }
        
        /* Ensure nav items have proper structure */
        .bottom-nav a.nav-item {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            text-decoration: none !important;
            height: 60px !important;
        }
        
        /* Control navigation visibility based on screen size */
        @media (max-width: 968px) {
            .filter-container {
                bottom: 5rem;
            }
            .status-toggle-container {
                top: 60px;
            }
            .desktop-footer {
                display: none !important;
                visibility: hidden !important;
            }
            
            .mobile-nav {
                display: flex !important;
                visibility: visible !important;
            }
        }
        
        @media (min-width: 969px) {
            .mobile-nav {
                display: none !important;
                visibility: hidden !important;
            }
            
            .desktop-footer {
                display: flex !important;
                visibility: visible !important;
            }
            
            /* Adjust map container for desktop */
            #map {
                height: calc(100% - 60px) !important;
                bottom: 60px !important;
            }
        }
    </style>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Mock Data for Development -->
    <script src="./src/js/mock-data.js"></script>
    
    <!-- Fixed Navigation - Simple and reliable -->
    <script src="./src/js/fixed-navigation.js"></script>
    
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Configuration -->
    <script src="./src/js/config.js"></script>
    
    <!-- Authentication -->
    <script src="./src/js/auth.js"></script>
</head>
<body>
    <!-- Top Navigation Bar with Account Dropdown -->
    <div class="top-nav">
        <div class="top-nav-logo">
            <span>TrashDrop</span>
        </div>
        
        <div class="top-nav-actions">
            <div class="account-dropdown">
                <button class="account-dropdown-btn">
                    <span class="material-icons">person</span>
                    <span class="dropdown-label" id="userDisplayName">Account</span>
                </button>
                <div class="account-dropdown-content">
                    <a href="./account.html" class="dropdown-item">
                        <span class="material-icons">account_circle</span>
                        My Profile
                    </a>
                    <a href="./account.html#settings-tab" class="dropdown-item">
                        <span class="material-icons">settings</span>
                        Settings
                    </a>
                    <a href="./account.html#support-tab" class="dropdown-item">
                        <span class="material-icons">help</span>
                        Support
                    </a>
                    <div class="dropdown-divider"></div>
                    <a href="#" class="dropdown-item" id="topNavSignOut">
                        <span class="material-icons">logout</span>
                        Sign Out
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="app-container">
        <div class="map-container">
            <div id="map"></div>
            
            <!-- Status toggle container -->            
            <div class="status-toggle-container" style="position:fixed; top:70px; left:50%; transform:translateX(-50%); z-index:1010;">
                <div style="background-color:white; border-radius:24px; padding:0.25rem 0.5rem; box-shadow:0 2px 6px rgba(0,0,0,0.15); display:flex; align-items:center;">
                    <label for="onlineToggle" style="display:flex; align-items:center; white-space:nowrap; font-size:0.9rem;">
                        <span id="statusText" style="margin-right:0.5rem;">Offline</span>
                        <div style="position:relative; width:36px; height:18px;">
                            <input type="checkbox" id="onlineToggle" class="toggle-input" style="opacity:0; width:0; height:0;">
                            <span class="toggle-slider" style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:34px;">
                                <span class="toggle-slider-button" style="position:absolute; content:''; height:14px; width:14px; left:2px; bottom:2px; background-color:white; transition:.4s; border-radius:50%;"></span>
                            </span>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- List View button container -->            
            <div class="list-view-btn-container" style="position:fixed; top:120px; right:10px; z-index:2000;">
                <button id="listViewBtn" style="background-color:#4CAF50; color:white; border-radius:24px; padding:0.6rem 1.25rem; font-weight:500; box-shadow:0 2px 6px rgba(0,0,0,0.2); border:none; font-size:0.95rem; cursor:pointer;">List View</button>
            </div>
            
            <!-- Request count badge container -->            
            <div class="request-count-badge-container" style="position:absolute; top:160px; left:10px; z-index:2000;">
                <div id="requestCountBadge" style="background-color:#FF5722; color:white; border-radius:50%; width:2.25rem; height:2.25rem; display:flex; justify-content:center; align-items:center; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.2); font-size:0.95rem;">0</div>
            </div>
            
            <!-- Filter container -->            
            <div class="filter-container" style="position:fixed; bottom:4.5rem; left:0; right:0; z-index:999;">
                <div style="background-color:white; margin:0 0.75rem; border-radius:8px; padding:1rem; box-shadow:0 2px 10px rgba(0,0,0,0.2); border:1px solid rgba(0,0,0,0.05);">
                    <h3 style="margin-bottom:1rem; display:none;" class="desktop-only">Filters</h3>
                    
                    <!-- Radius filter with better spacing -->
                    <div style="margin-bottom:1.5rem;">
                        <label for="radiusSlider" style="display:flex; justify-content:space-between; margin-bottom:0.75rem; font-weight:500; font-size:0.9rem; align-items:center;">
                            Radius: 
                            <span style="background:#4CAF50; color:white; border-radius:50%; width:28px; height:28px; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:0.85rem;" id="radiusValue">5</span>
                        </label>
                        <input type="range" id="radiusSlider" min="1" max="10" value="5" style="width:100%; margin:8px 0; height:6px; -webkit-appearance:none; background:#e0e0e0; border-radius:3px; outline:none;">
                    </div>
                    
                    <!-- Filter buttons with grid layout to prevent wrapping issues -->
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; margin-top:0.5rem;">
                        <button class="filter-btn active" data-type="all" style="white-space:nowrap; padding:0.5rem 0.25rem; border-radius:6px; border:1px solid #e0e0e0; background-color:white; color:#555; font-size:0.85rem; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s ease;">All Types</button>
                        <button class="filter-btn" data-type="recyclable" style="white-space:nowrap; padding:0.5rem 0.25rem; border-radius:6px; border:1px solid #e0e0e0; background-color:white; color:#555; font-size:0.85rem; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s ease;">Recyclable</button>
                        <button class="filter-btn" data-type="general" style="white-space:nowrap; padding:0.5rem 0.25rem; border-radius:6px; border:1px solid #e0e0e0; background-color:white; color:#555; font-size:0.85rem; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s ease;">General</button>
                        <button class="filter-btn" data-type="hazardous" style="white-space:nowrap; padding:0.5rem 0.25rem; border-radius:6px; border:1px solid #e0e0e0; background-color:white; color:#555; font-size:0.85rem; height:36px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.2s ease;">Hazardous</button>
                    </div>
                    
                    <!-- Extra bottom padding to ensure space at bottom -->
                    <div style="height:0.5rem;"></div>
                </div>
            </div>
        </div>
        
        <!-- Mobile bottom navigation (only visible on mobile) -->
        <div class="mobile-nav" style="position:fixed;bottom:0;left:0;right:0;height:60px;background-color:#fff;display:flex;justify-content:space-around;align-items:center;box-shadow:0 -2px 10px rgba(0,0,0,0.1);z-index:1001;">
            <a href="./map.html" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:#4CAF50;">
                <i class="material-icons" style="font-size:24px;">map</i>
                <span style="font-size:12px;margin-top:4px;display:block;">Map</span>
            </a>
            <a href="./request.html" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:#757575;">
                <i class="material-icons" style="font-size:24px;">add_circle</i>
                <span style="font-size:12px;margin-top:4px;display:block;">Request</span>
            </a>
            <a href="./assign.html" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:#757575;">
                <i class="material-icons" style="font-size:24px;">assignment</i>
                <span style="font-size:12px;margin-top:4px;display:block;">Assign</span>
            </a>
            <a href="./earnings.html" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:#757575;">
                <i class="material-icons" style="font-size:24px;">account_balance_wallet</i>
                <span style="font-size:12px;margin-top:4px;display:block;">Earnings</span>
            </a>
        </div>
        
        <!-- Desktop footer navigation - desktop only with !important flags -->
        <footer class="desktop-footer" style="position:fixed !important;bottom:0 !important;left:0 !important;right:0 !important;height:60px !important;background-color:#fff !important;display:flex !important;justify-content:space-around !important;align-items:center !important;z-index:9999 !important;border-top:1px solid #eee !important;width:100% !important;">
            <a href="./map.html" style="flex:1 !important;display:flex !important;flex-direction:column !important;align-items:center !important;justify-content:center !important;text-decoration:none !important;color:#4CAF50 !important;">
                <i class="material-icons" style="font-size:24px !important;">map</i>
                <span style="font-size:12px !important;margin-top:4px !important;">Map</span>
            </a>
            <a href="./request.html" style="flex:1 !important;display:flex !important;flex-direction:column !important;align-items:center !important;justify-content:center !important;text-decoration:none !important;color:#757575 !important;">
                <i class="material-icons" style="font-size:24px !important;">add_circle</i>
                <span style="font-size:12px !important;margin-top:4px !important;">Request</span>
            </a>
            <a href="./assign.html" style="flex:1 !important;display:flex !important;flex-direction:column !important;align-items:center !important;justify-content:center !important;text-decoration:none !important;color:#757575 !important;">
                <i class="material-icons" style="font-size:24px !important;">assignment</i>
                <span style="font-size:12px !important;margin-top:4px !important;">Assign</span>
            </a>
            <a href="./earnings.html" style="flex:1 !important;display:flex !important;flex-direction:column !important;align-items:center !important;justify-content:center !important;text-decoration:none !important;color:#757575 !important;">
                <i class="material-icons" style="font-size:24px !important;">account_balance_wallet</i>
                <span style="font-size:12px !important;margin-top:4px !important;">Earnings</span>
            </a>
        </footer>
        
        <!-- Notifications Container -->
        <div id="notificationsContainer" class="notifications-container"></div>
    </div>

    <!-- Top Navigation JavaScript -->
    <script src="./src/js/top-nav.js"></script>
    
    <!-- Custom styling for map and filter buttons with responsive design -->
    <style>
        /* High specificity styling for active filter buttons */
        .filter-btn.active {
            background-color: #4CAF50 !important;
            color: white !important;
            border-color: #388E3C !important;
            font-weight: 600 !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Green toggle switch styling */
        input.toggle-input:checked + .toggle-slider {
            background-color: #4CAF50 !important;
        }
        
        input.toggle-input:checked + .toggle-slider .toggle-slider-button {
            transform: translateX(18px) !important;
        }
        
        .toggle-slider {
            transition: background-color 0.4s !important;
        }
        
        .toggle-slider-button {
            transition: transform 0.4s !important;
        }
        
        /* Common styles for all screen sizes */
        body {
            margin: 0 !important;
            padding: 0 !important;
            height: 100vh !important;
        }
        
        .app-container {
            padding: 0 !important;
            margin: 0 !important;
        }
        
        /* Mobile view (default) */
        @media (max-width: 968px) {
            body {
                overflow: hidden !important;
            }
            
            .map-container {
                position: absolute !important;
                top: 60px !important; /* Height of the top nav */
                bottom: 60px !important; /* Height of bottom nav */
                left: 0 !important;
                right: 0 !important;
                height: auto !important;
                overflow: hidden !important;
            }
            
            #map {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                height: 100% !important;
                width: 100% !important;
                z-index: 1 !important;
            }
            
            .status-toggle-container {
                position: fixed !important;
                top: 70px !important;
                left: 50% !important;
                transform: translateX(-50%) !important;
                z-index: 1010 !important;
            }
            
            .list-view-btn-container {
                position: fixed !important;
                top: 120px !important;
                right: 10px !important;
                z-index: 2000 !important;
            }
            
            .request-count-badge-container {
                position: absolute !important;
                top: 160px !important;
                left: 10px !important;
                z-index: 2000 !important;
            }
            
            .filter-container {
                position: fixed !important;
                bottom: 4.5rem !important;
                left: 0 !important;
                right: 0 !important;
                z-index: 999 !important;
            }
        }
        
        /* Web/Desktop view - Complete redesign for cleaner layout */
        @media (min-width: 969px) {
            body {
                overflow: hidden !important;
                background-color: #f5f5f5 !important;
            }
            
            /* Basic layout structure */
            .app-container {
                display: flex !important;
                flex-direction: column !important;
                height: 100vh !important;
                width: 100% !important;
            }
            
            /* Top navigation fixed position */
            .top-nav {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 60px !important;
                background: white !important;
                z-index: 1000 !important;
                box-shadow: 0 1px 4px rgba(0,0,0,0.1) !important;
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                padding: 0 20px !important;
            }
            
            /* Desktop bottom navigation styling */
            .desktop-nav {
                position: fixed !important;
                bottom: 0 !important;
                left: 0 !important;
                right: 0 !important;
                height: 60px !important;
                background-color: #fff !important;
                display: flex !important; /* Always show, we'll control via media query */
                justify-content: space-around !important;
                align-items: center !important;
                z-index: 1001 !important;
                border-top: 1px solid #eee !important;
                width: 100% !important;
            }
            
            /* Show desktop nav and hide mobile nav only on desktop */
            @media (min-width: 969px) {
                .desktop-nav {
                    display: flex !important;
                }
                
                .mobile-nav {
                    display: none !important;
                }
            }
            
            /* Make absolutely sure desktop-nav is hidden on mobile */
            @media (max-width: 968px) {
                .desktop-nav {
                    display: none !important;
                }
            }
            
            /* No need for additional desktop-nav a styling as it's now inline */
            .desktop-nav a:not([style]) {
                display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                justify-content: center !important;
                text-decoration: none !important;
                color: #757575 !important;
            }
            
            .desktop-nav a:hover {
                color: #4CAF50 !important;
            }
            
            .desktop-nav a.active:not([style]) {
                color: #4CAF50 !important;
            }
            
            /* Main content area with sidebar and map */
            .map-container {
                position: fixed !important;
                top: 60px !important; /* Below top nav */
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                display: flex !important;
                flex-direction: row !important;
            }
            
            /* Sidebar for filters */
            .filter-container {
                position: relative !important;
                left: 0 !important;
                top: 0 !important;
                bottom: 60px !important; /* Account for bottom nav */
                width: 280px !important;
                height: calc(100% - 60px) !important; /* Account for bottom nav */
                background-color: white !important;
                border-right: 1px solid #e0e0e0 !important;
                box-shadow: 0 0 10px rgba(0,0,0,0.1) !important;
                padding: 1.5rem !important;
                overflow-y: auto !important;
                z-index: 10 !important;
                display: block !important;
            }
            
            .filter-container > div {
                background-color: white !important;
                border: none !important;
                box-shadow: none !important;
                padding: 0 !important;
                margin: 0 0 2rem 0 !important;
                border-radius: 0 !important;
            }
            
            /* Map positioning */
            #map {
                flex: 1 !important;
                height: 100vh !important; /* Full viewport height */
                width: 100% !important;
                position: fixed !important;
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
                touch-action: pan-x pan-y; /* Better touch handling */
                background-color: #f5f5f5; /* Fallback background */
                -webkit-overflow-scrolling: touch !important;
                transform: translateZ(0);
                backface-visibility: hidden;
                touch-action: pan-x pan-y;
                -webkit-tap-highlight-color: transparent;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                z-index: 1 !important;
                -webkit-overflow-scrolling: touch !important; /* Smooth scrolling on iOS */
                touch-action: pan-x pan-y !important; /* Enable touch gestures */
            }
            
            /* Ensure map container doesn't interfere with touch events */
            .leaflet-container {
                background: #fff !important;
                outline: 0 !important;
                -webkit-tap-highlight-color: transparent !important;
            }
            
            /* Map controls repositioning */
            .status-toggle-container {
                position: absolute !important;
                top: 20px !important;
                left: 300px !important; /* Position to the right of the sidebar */
                transform: none !important;
                z-index: 1010 !important;
            }
            
            .list-view-btn-container {
                position: absolute !important;
                top: 20px !important;
                right: 20px !important;
                z-index: 2000 !important;
            }
            
            .request-count-badge-container {
                position: absolute !important;
                top: 20px !important;
                left: 460px !important; /* Position next to status toggle */
                z-index: 2000 !important;
            }
            
            /* Show filter title on desktop */
            .desktop-only {
                display: block !important;
                font-size: 1.2rem !important;
                font-weight: 600 !important;
                color: #333 !important;
                margin-bottom: 1.5rem !important;
            }
            
            /* Improved filter buttons */
            .filter-container .filter-btn {
                height: 44px !important;
                font-size: 0.95rem !important;
                border-radius: 6px !important;
                margin-bottom: 6px !important;
            }
            
            /* Only hide mobile navigation on desktop, not desktop navigation */
            .mobile-nav[style*="position:fixed;bottom:0;left:0;right:0;height:60px;"] {
                display: none !important;
            }
            
            /* Improved form controls */
            #radiusSlider {
                height: 8px !important;
                background-color: #e0e0e0 !important;
                border-radius: 4px !important;
            }
            
            #radiusValue {
                width: 32px !important;
                height: 32px !important;
            }
            
            .leaflet-control-zoom {
                margin-top: 20px !important;
                margin-left: 20px !important;
            }
            
            /* Grid layout for filter buttons on desktop */
            .filter-container div[style*="display:grid"] {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
        }
        
        .leaflet-control-container {
            z-index: 5 !important;
        }
        
        /* Optimize map tiles for better mobile performance */
        .leaflet-tile {
            will-change: transform;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        /* Improve touch feedback */
        .leaflet-container:active {
            cursor: move;
        }
        
        /* Prevent text selection during interactions */
        .leaflet-container {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            outline: none;
        }
        
        /* Optimize map container for hardware acceleration */
        .map-container {
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            will-change: transform;
            overflow: hidden;
        }
        
        /* Optimize map rendering */
        #map {
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            -webkit-perspective: 1000;
            perspective: 1000;
            -webkit-transform-style: preserve-3d;
            transform-style: preserve-3d;
        }
        
        /* Optimize map tiles */
        .leaflet-tile {
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        
        /* Prevent layout shifts */
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        /* Optimize rendering for mobile */
        .app-container {
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
    </style>
    
    <!-- Map JavaScript -->
    <script src="./src/js/map.js"></script>
    
    <script>
    // Global state management
    (function() {
        // Initialize global state if not exists
        window.TrashDrop = window.TrashDrop || {};
        
        // Initialize state with default values
        window.TrashDrop.state = {
            currentRadius: parseInt(sessionStorage.getItem('currentRadius')) || 5,
            currentTrashType: sessionStorage.getItem('currentTrashType') || 'all',
            currentPosition: null,
            mapInitialized: false,
            filtersInitialized: false
        };

        // Initialize filter function
        if (!window.TrashDrop.filterRequestsByType) {
            window.TrashDrop.filterRequestsByType = function(trashType) {
                console.log('Filtering by:', trashType);
                window.TrashDrop.state.currentTrashType = trashType;
                sessionStorage.setItem('currentTrashType', trashType);
                
                if (window.TrashDrop.state.currentPosition) {
                    window.fetchNearbyRequests(
                        window.TrashDrop.state.currentPosition, 
                        window.TrashDrop.state.currentRadius, 
                        trashType
                    );
                }
                
                // Update active button
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    if (btn.getAttribute('data-type') === trashType) {
                        btn.classList.add('active');
                    } else {
                        btn.classList.remove('active');
                    }
                });
            };
        }

        
        // Initialize radius update function
        if (!window.TrashDrop.updateRadius) {
            window.TrashDrop.updateRadius = function(radius) {
                radius = parseInt(radius);
                window.TrashDrop.state.currentRadius = radius;
                sessionStorage.setItem('currentRadius', radius);
                
                // Update UI
                const radiusValue = document.getElementById('radiusValue');
                if (radiusValue) radiusValue.textContent = radius;
                
                if (window.TrashDrop.state.currentPosition) {
                    if (window.addRadiusCircle) {
                        window.addRadiusCircle(window.TrashDrop.state.currentPosition, radius);
                    }
                    if (window.fetchNearbyRequests) {
                        window.fetchNearbyRequests(
                            window.TrashDrop.state.currentPosition, 
                            radius, 
                            window.TrashDrop.state.currentTrashType
                        );
                    }
                }
            };
        }
        
        // Expose to window
        window.filterRequestsByType = window.TrashDrop.filterRequestsByType;
        window.updateRadius = window.TrashDrop.updateRadius;
    })();
    </script>
    
    <!-- Main Application Script -->
    <script>
        // Debug function to log authentication state
        function debugAuthState() {
            console.group('ðŸ” Auth State Debug (map.html)');
            const token = localStorage.getItem('auth_token');
            const user = localStorage.getItem('auth_user');
            const justLoggedIn = sessionStorage.getItem('justLoggedIn') === 'true';
            
            console.log('ðŸ“¦ localStorage:', {
                auth_token: token ? '***' : null,
                auth_user: user ? 'exists' : null,
                auth_session: localStorage.getItem('auth_session') ? '***' : null
            });
            console.log('ðŸ’¾ sessionStorage:', {
                justLoggedIn: justLoggedIn
            });
            console.log('ðŸ” Current auth state:', {
                token: token ? 'âœ…' : 'âŒ',
                user: user ? 'âœ…' : 'âŒ',
                justLoggedIn: justLoggedIn ? 'âœ…' : 'âŒ'
            });
            console.groupEnd();
        }
        
        // Main initialization function
        async function initializeApp() {
            console.log('ðŸ” map.html loaded, checking auth state...');
            
            try {
                // Check if user is authenticated
                const user = await checkAuth();
                if (!user) {
                    console.log('User not authenticated, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Initialize the map
                await initializeMap();
                
            } catch (error) {
                console.error('Error initializing application:', error);
                showNotification('Failed to initialize application', 'error');
            }
        }
        
        // Simple logout function
        window.logout = async function() {
            try {
                await window.signOut();
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                window.location.href = 'login.html';
            }
        };

        // Start the application
        async function startApp() {
            try {
                await initializeApp();
                
                // Ensure map container is visible and has dimensions
                const mapElement = document.getElementById('map');
                if (mapElement) {
                    mapElement.style.display = 'block';
                    if (mapElement.offsetHeight === 0) {
                        mapElement.style.height = '100vh';
                    }
                }
                
                // Initialize map after app is ready and container is ready
                if (typeof window.initMap === 'function') {
                    try {
                        // Debug map container state
                        const mapElement = document.getElementById('map');
                        console.log('Map container state:', {
                            exists: !!mapElement,
                            visible: mapElement ? window.getComputedStyle(mapElement).display !== 'none' : false,
                            dimensions: mapElement ? {
                                width: mapElement.offsetWidth,
                                height: mapElement.offsetHeight
                            } : null,
                            style: mapElement ? window.getComputedStyle(mapElement) : null
                        });

                        // Get user's current position or use default
                        let coords = [5.6037, -0.1870]; // Default Accra coordinates
                        
                        // Try to get user's current position
                        try {
                            const position = await new Promise((resolve, reject) => {
                                navigator.geolocation.getCurrentPosition(resolve, reject);
                            });
                            if (position && position.coords) {
                                coords = [position.coords.latitude, position.coords.longitude];
                                window.TrashDrop.state.currentPosition = {
                                    lat: coords[0],
                                    lng: coords[1]
                                };
                            }
                        } catch (geoError) {
                            // Silently handle geolocation errors - we'll use default coordinates
                            console.debug('Using default location - geolocation not available');
                        }
                        
                        // Initialize map with coordinates
                        await window.initMap(coords);
                        console.log('Map initialized successfully at:', coords);
                        window.TrashDrop.state.mapInitialized = true;
                        
                        // Initialize filters and buttons
                        initializeFilters();
                        
                        // Initial data load (this will trigger filter setup)
                        loadInitialData();
                    } catch (err) {
                        console.error('Map initialization failed:', err);
                        showNotification('Failed to load map. Please try again.', 'error');
                    }
                }
            } catch (err) {
                console.error('App initialization failed:', err);
                showNotification('Failed to initialize application', 'error');
            }
        }
        
        // Initialize filters with saved values
        function initializeFilters() {
            try {
                // Set up radius slider
                const radiusSlider = document.getElementById('radiusSlider');
                if (radiusSlider) {
                    radiusSlider.value = window.TrashDrop.state.currentRadius;
                    const radiusValue = document.getElementById('radiusValue');
                    if (radiusValue) radiusValue.textContent = window.TrashDrop.state.currentRadius;
                    
                    radiusSlider.addEventListener('input', (e) => {
                        const radius = parseInt(e.target.value);
                        const radiusValue = document.getElementById('radiusValue');
                        if (radiusValue) radiusValue.textContent = radius;
                        window.TrashDrop.updateRadius(radius);
                    });
                }
                
                // Set initial active filter button
                const activeBtn = document.querySelector(`.filter-btn[data-type="${window.TrashDrop.state.currentTrashType}"]`);
                if (activeBtn) {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    activeBtn.classList.add('active');
                }
                
                window.TrashDrop.state.filtersInitialized = true;
            } catch (err) {
                console.error('Error initializing filters:', err);
            }
        }
        
        // Trash type filter functionality
        function setupFilterButtons() {
            try {
                console.log('Setting up filter buttons...');
                const filterBtns = document.querySelectorAll('.filter-btn');
                
                // Make sure we have the filter buttons
                if (!filterBtns || filterBtns.length === 0) {
                    console.warn('No filter buttons found, will retry...');
                    setTimeout(setupFilterButtons, 500);
                    return;
                }
                
                console.log(`Found ${filterBtns.length} filter buttons`);
                
                // Initialize TrashDrop state if not exists
                window.TrashDrop = window.TrashDrop || {
                    state: {
                        currentPosition: null,
                        currentRadius: 5,
                        currentTrashType: 'all',
                        mapInitialized: false,
                        filtersInitialized: false
                    },
                    map: null,
                    locateControl: null
                };
                
                // Function to handle filter button click
                function handleFilterClick(event) {
                    const button = event.currentTarget;
                    console.log('Filter button clicked');
                    
                    // Remove active class from all buttons
                    filterBtns.forEach(b => b.classList.remove('active'));
                    
                    // Add active class to clicked button
                    button.classList.add('active');
                    
                    // Get the filter type from data-type attribute
                    const filterType = button.getAttribute('data-type');
                    
                    if (!filterType) {
                        console.warn('No data-type attribute found on filter button');
                        return;
                    }
                    
                    console.log('Filtering by type:', filterType);
                    
                    // Update the current trash type in state
                    window.TrashDrop.state.currentTrashType = filterType;
                    
                    // Call filter function
                    if (window.TrashDrop.filterRequestsByType) {
                        console.log('Calling TrashDrop.filterRequestsByType with:', filterType);
                        window.TrashDrop.filterRequestsByType(filterType);
                    } else if (window.filterRequestsByType) {
                        console.log('Calling window.filterRequestsByType with:', filterType);
                        window.filterRequestsByType(filterType);
                    } else {
                        console.error('Could not find filterRequestsByType function');
                    }
                }
                
                // Add click event to each button
                filterBtns.forEach(btn => {
                    btn.removeEventListener('click', handleFilterClick); // Remove any existing listeners
                    btn.addEventListener('click', handleFilterClick);
                });
                
                // Set initial active filter
                const state = window.TrashDrop.state;
                const initialFilter = state.currentTrashType || 'all';
                const initialBtn = Array.from(filterBtns).find(btn => 
                    btn.getAttribute('data-type') === initialFilter
                );
                
                console.log('Setting initial filter:', initialFilter);
                
                if (initialBtn) {
                    initialBtn.classList.add('active');
                } else if (filterBtns.length > 0) {
                    filterBtns[0].classList.add('active');
                }
                
                console.log('Filter buttons setup complete');
                
            } catch (error) {
                console.error('Error in setupFilterButtons:', error);
            }
        }
        
        // Load initial data function
        async function loadInitialData() {
            try {
                console.log('Loading initial data...');
                
                // Check if we have a map and current position
                if (window.TrashDrop?.map && window.TrashDrop.state?.currentPosition) {
                    const { currentPosition, currentRadius, currentTrashType } = window.TrashDrop.state;
                    console.log('Fetching requests for position:', currentPosition);
                    
                    // Fetch nearby requests with current filters
                    if (window.fetchNearbyRequests) {
                        await window.fetchNearbyRequests(
                            currentPosition,
                            currentRadius,
                            currentTrashType
                        );
                    } else {
                        console.warn('fetchNearbyRequests function not found');
                    }
                } else {
                    console.log('Map or position not ready, will retry...');
                    setTimeout(loadInitialData, 1000);
                }
            } catch (error) {
                console.error('Error loading initial data:', error);
                // Retry after delay
                setTimeout(loadInitialData, 2000);
            }
        }
        
        // Initialize the app with enhanced error handling and mobile support
        async function initApp() {
            console.log('Initializing TrashDrop Collector...');
            
            // Check Supabase connection
            if (!window.supabase) {
                console.error('Supabase client not initialized');
                showNotification('Error: Authentication service not available', 'error');
                return;
            }
            
            // Check if we're in mobile view
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                document.documentElement.classList.add('mobile');
                console.log('Mobile device detected');
            }
            
            // Initialize TrashDrop state if not exists
            window.TrashDrop = window.TrashDrop || {
                state: {
                    currentPosition: null,
                    currentRadius: 5,
                    currentTrashType: 'all',
                    mapInitialized: false,
                    filtersInitialized: false,
                    isMobile: isMobile
                },
                map: null,
                markers: {},
                supabase: window.supabase // Reference to Supabase client
            };
            
            // Set up filter buttons first
            console.log('Setting up filter buttons...');
            setupFilterButtons();
            
            // Initialize the app
            console.log('Starting app...');
            if (window.startApp) {
                try {
                    await window.startApp();
                    
                    // Load initial data
                    console.log('Loading initial data...');
                    await loadInitialData();
                    
                    console.log('App initialization complete');
                    
                    // Update UI based on auth state
                    if (typeof updateAuthUI === 'function') {
                        const user = await getCurrentUser();
                        updateAuthUI(user);
                    }
                } catch (error) {
                    console.error('Error during app initialization:', error);
                    showNotification('Error initializing application', 'error');
                }
            } else {
                console.warn('startApp function not found');
                showNotification('Error: Application initialization failed', 'error');
            }
        }
        
        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded, starting app initialization...');
            initApp().catch(console.error);
        });

        // Map initialization function with enhanced mobile support
        async function initializeMap() {
            // Ensure map container is visible and has dimensions
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error('Map container not found');
                return;
            }

            // Set up map container
            mapElement.style.display = 'block';
            mapElement.style.width = '100%';
            mapElement.style.height = '100vh';
            
            // Force a reflow to ensure dimensions are applied
            mapElement.offsetHeight;
            
            // Check if we have valid dimensions
            if (mapElement.offsetHeight === 0 || mapElement.offsetWidth === 0) {
                console.warn('Map container has zero dimensions, retrying...');
                setTimeout(initializeMap, 100);
                return;
            }
            try {
                // Wait for DOM and Leaflet to be fully loaded
                await new Promise(resolve => {
                    if (document.readyState === 'complete' || document.readyState === 'interactive') {
                        resolve();
                    } else {
                        document.addEventListener('DOMContentLoaded', resolve);
                    }
                });

                // Check if Leaflet is loaded
                if (typeof L === 'undefined') {
                    console.error('Leaflet not loaded');
                    return;
                }


                // Create map with mobile-optimized options
                const map = L.map('map', {
                    center: [5.6037, -0.1870],
                    zoom: 13,
                    zoomControl: false, // We'll add a custom control
                    tap: true,
                    touchZoom: true,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    boxZoom: true,
                    keyboard: true,
                    dragging: true,
                    inertia: true,
                    inertiaDeceleration: 3000,
                    inertiaMaxSpeed: 10,
                    easeLinearity: 0.2,
                    worldCopyJump: false,
                    maxBounds: [[-90, -180], [90, 180]],
                    maxBoundsViscosity: 0.5,
                    // @ts-ignore - Touch extend is a valid option
                    tapTolerance: 25, // Increased tap tolerance for mobile
                    // @ts-ignore - Touch extend is a valid option
                    touchExtend: true,
                    // @ts-ignore - Touch extend is a valid option
                    touchExtendOptions: {
                        touchAction: 'auto',
                        passive: true
                    }
                });

                // Add tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Â© OpenStreetMap contributors',
                    maxZoom: 19,
                    detectRetina: true,
                    crossOrigin: true
                }).addTo(map);

                // Add custom zoom controls for better mobile UX
                L.control.zoom({
                    position: 'bottomright',
                    zoomInText: '+',
                    zoomOutText: '-',
                    zoomInTitle: 'Zoom in',
                    zoomOutTitle: 'Zoom out'
                }).addTo(map);


                // Handle map events for better mobile interaction
                function onMapTouchStart(e) {
                    if (e.originalEvent && e.originalEvent.touches && e.originalEvent.touches.length > 1) {
                        // Prevent default for multi-touch events to avoid page scrolling
                        e.originalEvent.preventDefault();
                    }
                }


                // Add touch event listeners
                map.on('touchstart', onMapTouchStart);


                // Handle window resize
                let resizeTimer;
                function handleResize() {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        map.invalidateSize({ pan: false, animate: false });
                    }, 250);
                }

                window.addEventListener('resize', handleResize);

                // Cleanup function
                return () => {
                    map.off('touchstart', onMapTouchStart);
                    window.removeEventListener('resize', handleResize);
                    map.remove();
                };

            } catch (error) {
                console.error('Error initializing map:', error);
                showNotification('Failed to load map. Please try refreshing the page.', 'error');
            }
        }


        // Add notification function
        function showNotification(message, type = 'info') {
            const notificationContainer = document.getElementById('notificationsContainer');
            
            if (!notificationContainer) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-message">${message}</span>
                </div>
                <button class="notification-close">&times;</button>
            `;
            
            notificationContainer.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    if (notification.parentNode === notificationContainer) {
                        notificationContainer.removeChild(notification);
                    }
                }, 300);
            }, 5000);
            
            // Close button functionality
            const closeButton = notification.querySelector('.notification-close');
            if (closeButton) {
                closeButton.addEventListener('click', () => {
                    notification.classList.add('fade-out');
                    setTimeout(() => {
                        if (notification.parentNode === notificationContainer) {
                            notificationContainer.removeChild(notification);
                        }
                    }, 300);
                });
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Handle top navigation sign out
            const topNavSignOut = document.getElementById('topNavSignOut');
            if (topNavSignOut) {
                topNavSignOut.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        const { error } = await window.supabase.auth.signOut();
                        if (error) throw error;
                        localStorage.removeItem('auth_token');
                        window.location.href = './login.html';
                    } catch (error) {
                        console.error('Error signing out:', error);
                        showNotification('Error signing out. Please try again.', 'error');
                    }
                });
            }
            
            // Initialize the application
            (async function() {
                try {
                    // Check if user is logged in - use the same check as in initializeApp
                    const user = await checkAuth();
                    
                    if (!user) {
                        console.log('User not authenticated, redirecting to login');
                        // Add a small delay to prevent rapid redirects
                        await new Promise(resolve => setTimeout(resolve, 100));
                        window.location.href = 'login.html';
                        return;
                    }
                    
                    console.log('User logged in:', user.email);
                    
                    // Ensure map container exists and is visible
                    const mapContainer = document.getElementById('map');
                    if (!mapContainer) {
                        throw new Error('Map container not found');
                    }
                    
                    // Ensure Leaflet is loaded
                    if (typeof L === 'undefined') {
                        throw new Error('Leaflet library not loaded');
                    }
                    
                    // Initialize the map if not already done
                    if (!window.mapInstance) {
                        try {
                            console.log('Initializing map...');
                            
                            // Initialize the map with error handling
                            window.mapInstance = window.initMap([5.6037, -0.1870]);
                            
                            if (!window.mapInstance) {
                                throw new Error('Failed to initialize map: initMap returned null');
                            }
                            
                            console.log('Map initialized successfully');
                            
                            // Configure map interactions
                            const map = window.mapInstance;
                            
                            // Set up map event listeners
                            map.whenReady(() => {
                                try {
                                    // Enable map controls with proper touch handling
                                    if (map.touchZoom) map.touchZoom.enable({ tapTolerance: 10 });
                                    if (map.dragging) map.dragging.enable({ tapTolerance: 15 });
                                    if (map.doubleClickZoom) map.doubleClickZoom.enable();
                                    if (map.scrollWheelZoom) map.scrollWheelZoom.enable();
                                    if (map.boxZoom) map.boxZoom.enable();
                                    if (map.keyboard) map.keyboard.enable();
                                    
                                    // Mobile touch optimizations
                                    map.on('touchstart', function(e) {
                                        if (e.originalEvent.touches.length === 1) {
                                            map.dragging.enable();
                                        }
                                    });
                                    
                                    // Handle touch move for mobile
                                    map.on('touchmove', function() {
                                        if (map.dragging.enabled()) {
                                            map.dragging._draggable._onMove();
                                        }
                                    });
                                    
                                    // Force a small delay to ensure map is fully initialized
                                    setTimeout(() => {
                                        try {
                                            map.invalidateSize(true);
                                            console.log('Map is ready and resized');
                                        } catch (e) {
                                            console.error('Error resizing map:', e);
                                        }
                                    }, 100);
                                    
                                    console.log('Map is ready');
                                    
                                } catch (e) {
                                    console.error('Error configuring map interactions:', e);
                                }
                            });
                            
                            // Handle window resize with debounce
                            let resizeTimer;
                            window.addEventListener('resize', () => {
                                clearTimeout(resizeTimer);
                                resizeTimer = setTimeout(() => {
                                    try {
                                        if (window.mapInstance) {
                                            window.mapInstance.invalidateSize(true);
                                        }
                                    } catch (e) {
                                        console.error('Error during window resize:', e);
                                    }
                                }, 250);
                            });
                            
                        } catch (error) {
                            console.error('Failed to initialize map:', error);
                            showNotification('Failed to load map. Please refresh the page.', 'error');
                            return;
                        }
                    } else {
                        console.log('Using existing map instance');
                    }
                    
                    // Get user's current location
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { 
                                enableHighAccuracy: true,
                                timeout: 10000,  // 10 seconds
                                maximumAge: 0     // Force fresh position
                            });
                        });
                        
                        const { latitude, longitude } = position.coords;
                        const coords = [latitude, longitude];
                        
                        // Update map view to user's location
                        if (window.mapInstance) {
                            window.mapInstance.setView(coords, 15);
                            
                            // Add user marker
                            if (typeof addUserMarker === 'function') {
                                userMarker = addUserMarker(coords);
                            }
                            
                            // Update radius display and handle location data
                            const radius = parseInt(sessionStorage.getItem('currentRadius') || 5);
                            const radiusSlider = document.getElementById('radiusSlider');
                            const radiusValue = document.getElementById('radiusValue');
                            
                            if (radiusSlider && radiusValue) {
                                radiusSlider.value = radius;
                                radiusValue.textContent = radius;
                            }
                            
                            // Create radius circle using the addRadiusCircle function from map.js
                            radiusCircle = addRadiusCircle(coords, radius);
                            
                            // Set current position and radius (global variables in map.js)
                            currentPosition = coords;
                            currentRadius = radius;
                            
                            // Restore trash type filter from session if available
                            const trashType = sessionStorage.getItem('currentTrashType') || 'all';
                            currentTrashType = trashType; // Set global trash type filter
                            
                            const filterButtons = document.querySelectorAll('.filter-btn');
                            filterButtons.forEach(btn => btn.classList.remove('active'));
                            const activeButton = document.querySelector(`.filter-btn[data-type="${trashType}"]`);
                            if (activeButton) {
                                activeButton.classList.add('active');
                            }
                            
                            // Fetch nearby requests with restored filters
                            fetchNearbyRequests(coords, radius, trashType);
                            
                            // End of map instance block
                        }
                        
                    } catch (error) {
                        console.error('Geolocation error: Location access denied.');
                        console.error('Geolocation error:', error);
                        // Show error notification to user
                        showNotification('Could not access your location. Using default location.', 'warning');
                    }
            
            // Status toggle functionality
            const onlineToggle = document.getElementById('onlineToggle');
            const statusText = document.getElementById('statusText');
            
            // Restore online status from localStorage if available
            const savedStatus = localStorage.getItem('collectorOnlineStatus');
            if (savedStatus) {
                const isOnline = savedStatus === 'online';
                onlineToggle.checked = isOnline;
                statusText.textContent = isOnline ? 'Online' : 'Offline';
                if (isOnline) {
                    statusText.classList.add('online');
                    statusText.classList.remove('offline');
                } else {
                    statusText.classList.add('offline');
                    statusText.classList.remove('online');
                }
            }
            
            onlineToggle.addEventListener('change', async () => {
                const isOnline = onlineToggle.checked;
                statusText.textContent = isOnline ? 'Online' : 'Offline';
                
                if (isOnline) {
                    statusText.classList.add('online');
                    statusText.classList.remove('offline');
                    showNotification('You are now online and available for requests', 'success');
                } else {
                    statusText.classList.add('offline');
                    statusText.classList.remove('online');
                    showNotification('You are now offline', 'info');
                }
                
                // Update user status in database
                try {
                    await updateUserStatus(isOnline);
                } catch (error) {
                    console.error('Failed to update status:', error);
                    showNotification('Failed to update your status', 'error');
                }
            });
            
            // Initialize default position if not set yet (important to make radius circle work)
            if (!currentPosition) {
                currentPosition = [5.6037, -0.1870]; // Default to Accra if position not available
            }
            
            // Radius slider functionality
            const radiusSlider = document.getElementById('radiusSlider');
            const radiusValue = document.getElementById('radiusValue');
            
            // Initialize radius circle with current value on page load
            const initialRadius = parseInt(radiusSlider.value);
            radiusCircle = addRadiusCircle(currentPosition, initialRadius);
            
            radiusSlider.addEventListener('input', () => {
                const radius = parseInt(radiusSlider.value);
                radiusValue.textContent = radius;
                
                // Update global currentRadius variable
                currentRadius = radius;
                
                // Always update radius circle - ensures it displays regardless of geolocation
                radiusCircle = addRadiusCircle(currentPosition, radius);
                
                // Store selected radius in session
                sessionStorage.setItem('currentRadius', radius);
            });
            
            radiusSlider.addEventListener('change', () => {
                const radius = parseInt(radiusSlider.value);
                
                // Fetch requests with new radius using updateRadius function
                if (currentPosition) {
                    updateRadius(radius);
                }
            });
            
            // Trash type filter functionality
            function setupFilterButtons() {
                try {
                    console.log('Setting up filter buttons...');
                    const filterContainer = document.querySelector('.filter-container');
                    if (!filterContainer) {
                        console.error('Filter container not found');
                        return;
                    }

                    // Use event delegation for filter buttons
                    filterContainer.addEventListener('click', function(e) {
                        const filterBtn = e.target.closest('.filter-btn');
                        if (!filterBtn) return;

                        e.preventDefault();
                        e.stopPropagation();
                        
                        const trashType = filterBtn.getAttribute('data-type');
                        console.log('Filter button clicked:', trashType);
                        
                        // Update active button state
                        const filterButtons = filterContainer.querySelectorAll('.filter-btn');
                        filterButtons.forEach(btn => btn.classList.remove('active'));
                        filterBtn.classList.add('active');
                        
                        // Show loading state
                        const badge = document.getElementById('requestCountBadge');
                        if (badge) badge.textContent = '...';
                        
                        // Save filter preference
                        sessionStorage.setItem('currentTrashType', trashType);
                        
                        // Apply filter
                        if (window.TrashDrop?.filterRequestsByType) {
                            window.TrashDrop.filterRequestsByType(trashType);
                        } else if (window.filterRequestsByType) {
                            window.filterRequestsByType(trashType);
                        } else {
                            console.error('filterRequestsByType function not found');
                        }
                    });
                } catch (error) {
                    console.error('Error setting up filter buttons:', error);
                }
            }
            
            setupFilterButtons();
            
            const listViewBtn = document.getElementById('listViewBtn');
            if (listViewBtn) {
                listViewBtn.addEventListener('click', () => {
                    // Save current filters and radius
                    const currentTrashType = document.querySelector('.filter-btn.active')?.getAttribute('data-type') || 'all';
                    const currentRadius = document.getElementById('radiusSlider')?.value || 5000;
                    
                    // Store in sessionStorage
                    sessionStorage.setItem('currentTrashType', currentTrashType);
                    sessionStorage.setItem('currentRadius', currentRadius);
                    
                    // Navigate to list view
                    window.location.href = `list-view.html?type=${encodeURIComponent(currentTrashType)}&radius=${encodeURIComponent(currentRadius)}`;
                });
            }
            
            // Initialize filters with stored values if available
            try {
                const savedRadius = sessionStorage.getItem('currentRadius');
                const savedTrashType = sessionStorage.getItem('currentTrashType');
                
                if (savedRadius) {
                    const radiusSlider = document.getElementById('radiusSlider');
                    if (radiusSlider) {
                        radiusSlider.value = savedRadius;
                        const radiusValue = document.getElementById('radiusValue');
                        if (radiusValue) radiusValue.textContent = savedRadius;
                        updateRadius(parseInt(savedRadius));
                    }
                }
                
                if (savedTrashType) {
                    const activeBtn = document.querySelector(`.filter-btn[data-type="${savedTrashType}"]`);
                    if (activeBtn) {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        activeBtn.classList.add('active');
                        filterRequestsByType(savedTrashType);
                    }
                }
            } catch (error) {
                console.error('Error initializing filters:', error);
            }
            
            // Global error handler
            window.addEventListener('error', (event) => {
                console.error('Global error:', event.error);
                showNotification('An error occurred. Please try again.', 'error');
                return false; // Prevent default error handling
            });
        } catch (error) {
            console.error('Error in initialization:', error);
        }
    });
});

// Final initialization after everything is loaded
function finalInitialization() {
    try {
        console.log('Running final initialization...');
        
        // Check if TrashDrop state is properly initialized
        if (!window.TrashDrop || !window.TrashDrop.state) {
            console.error('TrashDrop state not properly initialized');
            window.TrashDrop = window.TrashDrop || {};
            window.TrashDrop.state = window.TrashDrop.state || {
                currentPosition: null,
                currentRadius: 5,
                currentTrashType: 'all',
                mapInitialized: false
            };
        }
        
        // Don't reinitialize map if it's already initialized
        if (window.TrashDrop.state.mapInitialized) {
            console.log('Map already initialized, skipping...');
            // Just invalidate size in case of container resize
            if (window.mapInstance) {
                setTimeout(() => {
                    try {
                        window.mapInstance.invalidateSize();
                    } catch (e) {
                        console.error('Error invalidating map size:', e);
                    }
                }, 100);
            }
            return;
        }
        
        // Initialize radius slider if not already done
        const savedRadius = sessionStorage.getItem('currentRadius') || '5000';
        const radiusSlider = document.getElementById('radiusSlider');
        if (radiusSlider) {
            radiusSlider.value = savedRadius;
            const radiusValue = document.getElementById('radiusValue');
            if (radiusValue) radiusValue.textContent = savedRadius;
            if (typeof window.updateRadius === 'function') {
                window.updateRadius(parseInt(savedRadius));
            }
        }
        
        // Initialize trash type filter
        const savedTrashType = sessionStorage.getItem('currentTrashType') || 'all';
        const activeBtn = document.querySelector(`.filter-btn[data-type="${savedTrashType}"]`);
        if (activeBtn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            activeBtn.classList.add('active');
            if (typeof window.filterRequestsByType === 'function') {
                console.log('Applying saved filter:', savedTrashType);
                window.filterRequestsByType(savedTrashType);
            }
        }
        
        console.log('Final initialization complete');
        console.log('Application initialization complete');
        
        return true;
    } catch (error) {
        console.error('Error in finalInitialization:', error);
        throw error;
    }
}

    // Enhanced authentication check with Supabase
    if (typeof window.checkAuth === 'undefined') {
        window.checkAuth = async function() {
            console.log('Checking authentication status...');
            
            if (!window.supabase) {
                console.error('Supabase client not available');
                return false;
            }
            
            try {
                const { data: { session }, error } = await window.supabase.auth.getSession();
                
                if (error) {
                    console.error('Error checking auth status:', error);
                    return false;
                }
                
                if (!session) {
                    console.log('No active session found');
                    return false;
                }
                
                console.log('User is authenticated:', session.user.email);
                
                // Update the UI if the function is available
                if (typeof updateAuthUI === 'function') {
                    updateAuthUI(session.user);
                }
                
                return true;
            } catch (error) {
                console.error('Error in checkAuth:', error);
                
                // If we get an error, redirect to login page if not already there
                if (!window.location.href.includes('login.html') && !window.location.search.includes('from=map')) {
                    console.log('Authentication error, redirecting to login...');
                    window.location.href = 'login.html?from=map';
                }
                
                return false;
            }
        };
    }

    // Start initialization with a small delay to ensure everything is loaded
    async function initializeApp() {
        console.log('Starting application initialization...');
        
        try {
            // Check authentication first
            const isAuthenticated = await checkAuth();
            if (!isAuthenticated) {
                return; // Stop initialization if not authenticated
            }
            
            // Wait for DOM to be fully loaded if needed
            if (document.readyState === 'loading') {
                await new Promise(resolve => {
                    document.addEventListener('DOMContentLoaded', resolve);
                });
            }
            
            console.log('Running final initialization...');
            await finalInitialization();
            
            // Setup filter buttons
            console.log('Setting up filter buttons...');
            if (typeof setupFilterButtons === 'function') {
                setupFilterButtons();
            } else {
                console.error('setupFilterButtons function not found');
            }
            
            console.log('Application initialization complete');
        } catch (error) {
            console.error('Error during initialization:', error);
            
            // Show error message to user
            const errorMessage = document.createElement('div');
            errorMessage.style.position = 'fixed';
            errorMessage.style.top = '10px';
            errorMessage.style.left = '50%';
            errorMessage.style.transform = 'translateX(-50%)';
            errorMessage.style.padding = '15px 20px';
            errorMessage.style.background = '#ffebee';
            errorMessage.style.borderLeft = '4px solid #c62828';
            errorMessage.style.borderRadius = '4px';
            errorMessage.style.zIndex = '9999';
            errorMessage.style.maxWidth = '90%';
            errorMessage.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
            errorMessage.style.fontFamily = 'Arial, sans-serif';
            
            // Different messages based on error type
            if (error?.message?.includes('auth') || error?.message?.includes('401')) {
                errorMessage.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #c62828; font-weight: bold;">Session Expired:</span>
                        <span>Please log in again to continue.</span>
                        <button onclick="window.location.href='login.html'" style="margin-left: 15px; padding: 4px 12px; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer;">Log In</button>
                    </div>
                `;
            } else {
                errorMessage.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: #c62828; font-weight: bold;">Error:</span>
                        <span>${error.message || 'An error occurred. Please try again.'}</span>
                        <button onclick="this.parentNode.parentNode.remove()" style="margin-left: 15px; padding: 2px 8px; background: #c62828; color: white; border: none; border-radius: 4px; cursor: pointer;">Ã—</button>
                    </div>
                `;
            }
            
            document.body.appendChild(errorMessage);
            
            // Auto-remove error message after 10 seconds
            setTimeout(() => {
                if (errorMessage.parentNode) {
                    errorMessage.parentNode.removeChild(errorMessage);
                }
            }, 10000);
        }
    }

    // Start the app after a short delay
    console.log('Starting initialization...');
    setTimeout(initializeApp, 100);
</script>
</body>
</html>
