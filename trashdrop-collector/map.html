<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map - TrashDrop Collector</title>
    <meta name="description" content="TrashDrop Collector map view">
    <link rel="stylesheet" href="./src/styles/main.css">
    <link rel="stylesheet" href="./src/styles/navigation.css">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- Fix for navigation labels -->
    <style>
        /* Full reset of navigation styles to ensure labels show */
        .bottom-nav a.nav-item div,
        .bottom-nav a.nav-item span {
            display: block !important;
            visibility: visible !important;
            font-size: 0.7rem !important;
            color: inherit !important;
            margin-top: 0.25rem !important;
            text-align: center !important;
            width: 100% !important;
            opacity: 1 !important;
        }
        
        .bottom-nav a.nav-item i.material-icons,
        .bottom-nav a.nav-item span.material-icons {
            font-size: 1.5rem !important;
            margin-bottom: 0.25rem !important;
            display: block !important;
        }
        
        /* Ensure nav items have proper structure */
        .bottom-nav a.nav-item {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
            text-decoration: none !important;
            height: 60px !important;
        }
    </style>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Mock Data for Development -->
    <script src="./src/js/mock-data.js"></script>
    
    <!-- Fixed Navigation - Simple and reliable -->
    <script src="./src/js/fixed-navigation.js"></script>
    
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Supabase JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
            
    <!-- Configuration -->
    <script src="./src/js/config.js"></script>
    
    <!-- Authentication -->
    <script src="./src/js/auth.js"></script>
</head>
<body>
    <div class="app-container">
        <div class="map-container">
            <div id="map"></div>
            
            <div class="map-controls">
                <div class="status-toggle">
                    <label for="onlineToggle" class="toggle-label">
                        <span id="statusText">Offline</span>
                        <div class="toggle-switch">
                            <input type="checkbox" id="onlineToggle">
                            <span class="toggle-slider"></span>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="map-overlay">
                <div id="requestCountBadge" class="request-count-badge">0</div>
                <div class="overlay-controls">
                    <button id="listViewBtn" class="btn btn-primary">List View</button>
                </div>
            </div>
            
            <div class="map-filters-container">
                <div class="map-filters">
                    <div class="radius-filter">
                        <label for="radiusSlider">Radius: <span id="radiusValue">5</span> km</label>
                        <input type="range" id="radiusSlider" min="1" max="20" value="5">
                    </div>
                    
                    <div class="trash-type-filter">
                        <button class="filter-btn active" data-type="all">All Types</button>
                        <button class="filter-btn" data-type="recyclable">Recyclable</button>
                        <button class="filter-btn" data-type="general">General</button>
                        <button class="filter-btn" data-type="hazardous">Hazardous</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Completely rebuilt bottom navigation -->
        <div style="position:fixed;bottom:0;left:0;right:0;height:60px;background-color:#fff;display:flex;justify-content:space-around;align-items:center;box-shadow:0 -2px 10px rgba(0,0,0,0.1);z-index:1001;">
            <a href="./map.html" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:#4CAF50;">
                <i class="material-icons" style="font-size:24px;">map</i>
                <span style="font-size:12px;margin-top:4px;display:block;">Map</span>
            </a>
            <a href="./request.html" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:#757575;">
                <i class="material-icons" style="font-size:24px;">add_circle</i>
                <span style="font-size:12px;margin-top:4px;display:block;">Request</span>
            </a>
            <a href="./assign.html" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:#757575;">
                <i class="material-icons" style="font-size:24px;">assignment</i>
                <span style="font-size:12px;margin-top:4px;display:block;">Assign</span>
            </a>
            <a href="./earnings.html" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:#757575;">
                <i class="material-icons" style="font-size:24px;">account_balance_wallet</i>
                <span style="font-size:12px;margin-top:4px;display:block;">Earnings</span>
            </a>
            <a href="./account.html" style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-decoration:none;color:#757575;">
                <i class="material-icons" style="font-size:24px;">person</i>
                <span style="font-size:12px;margin-top:4px;display:block;">Account</span>
            </a>
        </div>
        
        <!-- Notifications Container -->
        <div id="notificationsContainer" class="notifications-container"></div>
    </div>

    <!-- Main JavaScript -->
    <script src="./src/js/map.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Check if user is logged in
            const user = await getCurrentUser();
            
            if (!user) {
                // Redirect to login if not logged in
                window.location.href = './login.html';
                return;
            }
            
            // Initialize map using the initMap function from map.js
            // This ensures we use the global map variable defined in map.js
            initMap([5.6037, -0.1870]);
            
            
            // Get user's current location
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true });
                });
                
                const { latitude, longitude } = position.coords;
                const coords = [latitude, longitude];
                
                // Update map view to user's location using the global map variable
                map.setView(coords, 15);
                
                // Add user marker using the addUserMarker function from map.js
                userMarker = addUserMarker(coords);
                
                // Add radius circle (default 5km)
                const radius = parseInt(sessionStorage.getItem('currentRadius') || 5);
                document.getElementById('radiusSlider').value = radius;
                document.getElementById('radiusValue').textContent = radius;
                
                // Create radius circle using the addRadiusCircle function from map.js
                radiusCircle = addRadiusCircle(coords, radius);
                
                // Set current position and radius (global variables in map.js)
                currentPosition = coords;
                currentRadius = radius;
                
                // Restore trash type filter from session if available
                const trashType = sessionStorage.getItem('currentTrashType') || 'all';
                currentTrashType = trashType; // Set global trash type filter
                
                const filterButtons = document.querySelectorAll('.filter-btn');
                filterButtons.forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.filter-btn[data-type="${trashType}"]`).classList.add('active');
                
                // Fetch nearby requests with restored filters
                fetchNearbyRequests(coords, radius, trashType);
                
            } catch (error) {
                showNotification('Unable to access your location. Please enable location services.', 'error');
                console.error('Geolocation error:', error);
            }
            
            // Status toggle functionality
            const onlineToggle = document.getElementById('onlineToggle');
            const statusText = document.getElementById('statusText');
            
            // Restore online status from localStorage if available
            const savedStatus = localStorage.getItem('collectorOnlineStatus');
            if (savedStatus) {
                const isOnline = savedStatus === 'online';
                onlineToggle.checked = isOnline;
                statusText.textContent = isOnline ? 'Online' : 'Offline';
                if (isOnline) {
                    statusText.classList.add('online');
                    statusText.classList.remove('offline');
                } else {
                    statusText.classList.add('offline');
                    statusText.classList.remove('online');
                }
            }
            
            onlineToggle.addEventListener('change', async () => {
                const isOnline = onlineToggle.checked;
                statusText.textContent = isOnline ? 'Online' : 'Offline';
                
                if (isOnline) {
                    statusText.classList.add('online');
                    statusText.classList.remove('offline');
                    showNotification('You are now online and available for requests', 'success');
                } else {
                    statusText.classList.add('offline');
                    statusText.classList.remove('online');
                    showNotification('You are now offline', 'info');
                }
                
                // Update user status in database
                try {
                    await updateUserStatus(isOnline);
                } catch (error) {
                    console.error('Failed to update status:', error);
                    showNotification('Failed to update your status', 'error');
                }
            });
            
            // Radius slider functionality
            const radiusSlider = document.getElementById('radiusSlider');
            const radiusValue = document.getElementById('radiusValue');
            
            radiusSlider.addEventListener('input', () => {
                const radius = parseInt(radiusSlider.value);
                radiusValue.textContent = radius;
                
                // Update global currentRadius variable
                currentRadius = radius;
                
                // Update radius circle
                if (radiusCircle) {
                    radiusCircle.setRadius(radius * 1000);
                }
                
                // Store selected radius in session
                sessionStorage.setItem('currentRadius', radius);
            });
            
            radiusSlider.addEventListener('change', () => {
                const radius = parseInt(radiusSlider.value);
                
                // Fetch requests with new radius using updateRadius function
                if (currentPosition) {
                    updateRadius(radius);
                }
            });
            
            // Trash type filter functionality
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            filterButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active button
                    filterButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Get selected trash type
                    const trashType = btn.getAttribute('data-type');
                    
                    // Update global currentTrashType variable
                    currentTrashType = trashType;
                    
                    // Store selected type in session
                    sessionStorage.setItem('currentTrashType', trashType);
                    
                    // Fetch requests with new filter using filterRequestsByType function
                    filterRequestsByType(trashType);
                });
            });
            
            // List View button functionality
            const listViewBtn = document.getElementById('listViewBtn');
            listViewBtn.addEventListener('click', () => {
                // Use the navigateToListView function from map.js
                navigateToListView();
            });
        });
    </script>
</body>
</html>
                });
            });
            
            // List View button functionality
            const listViewBtn = document.getElementById('listViewBtn');
            
            listViewBtn.addEventListener('click', () => {
                // Use the navigateToListView function from map.js
                navigateToListView();
            });
        });
    </script>
</body>
</html>
