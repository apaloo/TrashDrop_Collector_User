<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrashDrop Collector - Authentication</title>
    <meta name="description" content="TrashDrop Collector App for waste management professionals">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- IMPORTANT: This page is a clean slate implementation specifically for testing the OTP flow -->
    <script>
        // Clear ALL storage on page load to ensure clean testing environment
        localStorage.clear();
        sessionStorage.clear();
        
        // Log clear confirmation
        console.log('üßπ All storage cleared for clean authentication testing');
    </script>
    
    <!-- Base styles only - no inherited styles that could cause issues -->
    <style>
        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .logo {
            max-width: 150px;
            margin-bottom: 1rem;
        }
        
        h1, h2 {
            color: var(--text-color);
            font-weight: 600;
        }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }
        
        h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        
        .card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 24px;
            margin-bottom: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-sizing: border-box;
            transition: border-color 0.3s, box-shadow 0.3s;
            background-color: #fff;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
            outline: none;
        }
        
        input.error {
            border-color: var(--error-color);
        }
        
        .input-prefix {
            position: relative;
        }
        
        .input-prefix input {
            padding-left: 40px;
        }
        
        .input-prefix::before {
            content: attr(data-prefix);
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #777;
            font-size: 16px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        input.error {
            border-color: #e74c3c;
        }
        
        .error-message {
            color: #e74c3c;
            margin-top: 5px;
            display: none;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        
        .steps {
            margin-top: 20px;
        }
        
        .step {
            padding: 15px;
            background-color: #f9f9f9;
            border-left: 3px solid #3498db;
            margin-bottom: 10px;
        }
        
        .verification-code {
            letter-spacing: 5px;
            font-size: 20px;
        }
        
        .debug-panel {
            margin-top: 30px;
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .debug-panel h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #3498db;
        }
        
        .hidden {
            display: none;
        }
        
        .status-indicator {
            padding: 8px 12px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 10px;
        }
        
        .status-pending {
            background-color: #f39c12;
            color: white;
        }
        
        .status-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-error {
            background-color: #e74c3c;
            color: white;
        }
    </style>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Clean, minimal script loading without auto-authentication -->
    <script>
        // Basic script loader
        function loadScript(src, onLoad) {
            return new Promise((resolve, reject) => {
                console.log('üì• Loading:', src);
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log('‚úÖ Loaded:', src);
                    if (onLoad) onLoad();
                    resolve();
                };
                script.onerror = (err) => {
                    console.error('‚ùå Error loading:', src, err);
                    reject(err);
                };
                document.head.appendChild(script);
            });
        }
        
        // Load required scripts in sequence
        async function loadAllScripts() {
            try {
                // 1. Load config first
                await loadScript('./src/js/config.js');
                
                // Set up Supabase config with proper URL formatting
                if (!window.CONFIG || !window.CONFIG.supabase) {
                    console.error('‚ùå Missing CONFIG or CONFIG.supabase');
                    window.CONFIG = window.CONFIG || {};
                    window.CONFIG.supabase = window.CONFIG.supabase || {
                        url: 'https://your-supabase-url.supabase.co',
                        key: 'your-supabase-anon-key'
                    };
                }
                
                // Setup a proper Supabase URL
                const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                if (!window.CONFIG.supabase.url || 
                    window.CONFIG.supabase.url.includes('localhost:3000') || 
                    window.CONFIG.supabase.url === 'https://your-supabase-url.supabase.co') {
                    console.warn('‚ö†Ô∏è Using development mode with mock Supabase authentication');
                    
                    // Create mock Supabase methods for development/testing
                    window.useMockSupabase = true;
                    
                    // Still set a URL so the real client doesn't break completely
                    window.CONFIG.supabase.url = 'https://xyzsupabase.supabase.co';
                    window.CONFIG.supabase.key = 'mock-key-for-development-only';
                }
                
                window.SUPABASE_CONFIG = {
                    url: window.CONFIG.supabase.url,
                    key: window.CONFIG.supabase.key
                };
                
                // 2. Load Supabase client - try multiple sources to ensure it loads
                try {
                    // First try the same URL that the main app uses
                    await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js');
                } catch (e) {
                    console.warn('First Supabase load attempt failed, trying alternate CDN:', e);
                    // Fall back to the specific version
                    await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js');
                }
                
                // Add extra debugging to see what's available
                console.log('Supabase library check:', {
                    'window.supabase': typeof window.supabase,
                    'window.supabase?.createClient': typeof window.supabase?.createClient
                });
                
                if (!window.supabase) {
                    throw new Error('Supabase library failed to load correctly');
                }
                
                // Add the debug div to the page to show the status
                const debugDiv = document.createElement('div');
                debugDiv.className = 'debug-info';
                debugDiv.style = 'padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: monospace;';
                document.body.appendChild(debugDiv);
                
                // Update debug div with library status
                debugDiv.innerHTML = `<p style="color:green">‚úÖ Supabase library loaded successfully</p>`;
                
                console.log('üîå Creating Supabase client');
                
                // Create client manually without relying on other scripts
                try {
                    // Debug info about the config
                    console.log('Supabase config check:', {
                        'URL available': !!window.SUPABASE_CONFIG.url,
                        'Key available': !!window.SUPABASE_CONFIG.key,
                        'URL length': window.SUPABASE_CONFIG.url?.length || 0,
                        'Key length': window.SUPABASE_CONFIG.key?.length || 0
                    });
                    
                    // Make sure we actually have required values
                    if (!window.SUPABASE_CONFIG.url || !window.SUPABASE_CONFIG.key) {
                        throw new Error('Missing Supabase URL or key in configuration');
                    }
                    
                    // Create client - either real or mock based on availability
                    if (window.useMockSupabase) {
                        console.log('‚ö†Ô∏è Creating mock Supabase client for offline testing');
                        
                        // Create a mock Supabase client with the required OTP methods
                        window.supabaseClient = {
                            auth: {
                                // Mock signInWithOtp that always succeeds
                                signInWithOtp: async function(options) {
                                    console.log('‚úÖ MOCK: Sending OTP to', options.phone);
                                    // Simulate network delay
                                    await new Promise(resolve => setTimeout(resolve, 800));
                                    return { data: {}, error: null };
                                },
                                
                                // Mock verifyOtp that always succeeds with test number +12345678901
                                verifyOtp: async function(options) {
                                    console.log('‚úÖ MOCK: Verifying OTP', options.token, 'for', options.phone);
                                    // Simulate network delay
                                    await new Promise(resolve => setTimeout(resolve, 800));
                                    
                                    // Simulate successful verification for test number or code 123456
                                    if (options.phone === '+12345678901' || options.token === '123456') {
                                        return {
                                            data: {
                                                user: {
                                                    id: 'test-user-id-123',
                                                    phone: options.phone,
                                                    user_metadata: { name: 'Test User' }
                                                },
                                                session: {
                                                    access_token: 'mock-token-' + Date.now(),
                                                    expires_at: Date.now() + 3600000,
                                                    refresh_token: 'mock-refresh-token'
                                                }
                                            },
                                            error: null
                                        };
                                    } else {
                                        // For any other phone number, simulate an error
                                        return {
                                            data: null,
                                            error: { message: 'Invalid verification code' }
                                        };
                                    }
                                },
                                
                                // Add other auth methods as needed
                                getUser: async function() {
                                    return {
                                        data: {
                                            user: {
                                                id: 'test-user-id-123',
                                                phone: '+12345678901',
                                                user_metadata: { name: 'Test User' }
                                            }
                                        },
                                        error: null
                                    };
                                }
                            }
                        };
                    } else {
                        // Create the real client
                        window.supabaseClient = window.supabase.createClient(
                            window.SUPABASE_CONFIG.url,
                            window.SUPABASE_CONFIG.key,
                            {
                                auth: {
                                    autoRefreshToken: true,
                                    persistSession: false // Don't persist session to avoid auto-login during testing
                                }
                            }
                        );
                    }
                    
                    // Verify client was created and has expected methods
                    if (!window.supabaseClient || !window.supabaseClient.auth) {
                        throw new Error('Supabase client created but missing expected properties');
                    }
                    
                    // Update debug div with client status
                    document.querySelector('.debug-info').innerHTML += 
                        `<p style="color:green">‚úÖ Supabase client initialized successfully</p>`;
                    
                    // Tell app the client is ready
                    window.dispatchEvent(new CustomEvent('supabaseClientReady'));
                    window.dispatchEvent(new CustomEvent('supabaseClientInitialized'));
                } catch (error) {
                    console.error('Failed to initialize Supabase client:', error);
                    document.querySelector('.debug-info').innerHTML += 
                        `<p style="color:red">‚ùå Supabase client initialization failed: ${error.message}</p>`;
                    throw error; // Re-throw so the outer catch can handle it properly
                }
                
                console.log('üî• All scripts loaded successfully!');
                
                // Safely handle DOM element references
                const loadingIndicator = document.querySelector('.loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // The main authentication forms are directly in the cards, not in a separate auth-form element
                const phoneAuthSection = document.getElementById('phone-number-auth-section');
                if (phoneAuthSection) {
                    phoneAuthSection.classList.remove('hidden');
                }
            } catch (error) {
                console.error('‚ùå Script loading failed:', error);
                
                // Safely handle DOM element references in error case
                const loadingIndicator = document.querySelector('.loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = `<div class="status-error">Error loading resources: ${error.message}</div>`;
                } else {
                    // Create and show error message if the loading indicator doesn't exist
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'status-error';
                    errorDiv.innerText = `Error loading resources: ${error.message}`;
                    document.querySelector('.container')?.prepend(errorDiv);
                }
            }
        }
        
        // Authentication fallback for testing
        window.getCurrentUserFallback = function() {
            console.log('üì± Using fallback test user');
            return {
                id: 'test-user-id-' + new Date().getTime(),
                email: 'test@example.com',
                phone: '+12345678901',
                user_metadata: {
                    name: 'Test User',
                    role: 'collector'
                }
            };
        };
        
        // Get current user function with graceful fallback
        window.getCurrentUser = async function() {
            try {
                if (!window.supabaseClient) {
                    console.warn('‚ö†Ô∏è Supabase client not initialized, using fallback');
                    return window.getCurrentUserFallback();
                }
                
                const { data, error } = await window.supabaseClient.auth.getUser();
                
                if (error) {
                    console.warn('‚ö†Ô∏è Error getting user, using fallback:', error.message);
                    return window.getCurrentUserFallback();
                }
                
                if (!data || !data.user) {
                    console.warn('‚ö†Ô∏è No user data, using fallback');
                    return window.getCurrentUserFallback();
                }
                
                return data.user;
            } catch (error) {
                console.warn('‚ö†Ô∏è Exception getting user, using fallback:', error.message);
                return window.getCurrentUserFallback();
            }
        };
        
        // Start loading on page load
        window.addEventListener('DOMContentLoaded', loadAllScripts);
    </script>
    
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
        }
        input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-primary {
            background: var(--primary-color);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background: var(--secondary-dark);
        }
        
        .btn-full {
            width: 100%;
            margin: 10px 0;
        }
        
        .btn-login {
            width: 100%;
            background: var(--secondary-color);
            margin: 15px 0;
            padding: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .btn-login:hover {
            background: var(--secondary-dark);
        }
        .forgot-password, .signup-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #2196F3;
            text-decoration: none;
        }
        .forgot-password:hover, .signup-link:hover {
            text-decoration: underline;
        }
        .auth-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        .result {
            background: #f1f1f1;
            padding: 1rem;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .error {
            color: red;
        }
        
        .status-indicator {
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 10px;
            display: inline-block;
        }
        
        .status-pending {
            background-color: #f39c12;
            color: white;
        }
        
        .status-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-error {
            background-color: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>TrashDrop Collector</h1>
            <p class="subtitle">Waste Management Professionals Portal</p>
        </div>
        
        <!-- Debug info and loading indicators -->
        <div class="loading-indicator" style="padding: 10px; text-align: center; margin-bottom: 15px;">Loading authentication resources...</div>
        <div class="debug-info" style="padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: monospace;"></div>
        
        <div class="card">
            <h2>Environment</h2>
            <div class="result" id="environmentInfo"></div>
        </div>
        
        <!-- Shareable configuration section -->
        <div class="card">
            <h2>Configuration Settings</h2>
            <div class="form-group">
                <label for="supabase-url">Supabase URL</label>
                <input type="text" id="supabase-url" placeholder="https://your-project-id.supabase.co">
            </div>
            <div class="form-group">
                <label for="supabase-key">Supabase Anon Key</label>
                <input type="text" id="supabase-key" placeholder="eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1..."> 
            </div>
            <div class="form-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-secondary" id="save-config">Save Configuration</button>
                <button class="btn-primary" id="generate-share-link">Generate Shareable Link</button>
                <button id="reset-config">Reset to Defaults</button>
            </div>
            <div class="share-area" style="margin-top: 15px; display: none;">
                <label for="share-link">Shareable Test Link</label>
                <div style="display: flex;">
                    <input type="text" id="share-link" readonly>
                    <button id="copy-link" style="margin-left: 10px;">Copy</button>
                </div>
                <p class="small-text" style="font-size: 0.85rem; color: #666;">Share this link with colleagues to test the app with the same configuration.</p>
            </div>
        </div>
        
        <!-- OTP test instructions -->
        <div class="card">
            <h2>Test Mode Instructions</h2>
            <p>For testing purposes, you can use the following credentials:</p>
            <ul>
                <li>Test Phone Number: <code>+12345678901</code></li>
                <li>Verification Code: <code>123456</code></li>
            </ul>
            <p><strong>Note:</strong> The mock client will automatically activate in development mode or if the Supabase URL is invalid/misconfigured.</p>
            <div class="status-message"></div>
        </div>

        <!-- Phone Number Authentication -->
        <div class="card" id="phone-number-auth-section">
            <h2>Phone Number Authentication</h2>
            <div class="form-group">
                <label for="phoneNumber">Phone Number (with country code)</label>
                <input type="tel" id="phoneNumber" placeholder="+1 (555) 555-5555" value="+12345678901">
                <div id="phone-error" style="color: #e74c3c; margin-top: 5px;"></div>
            </div>
            <button id="send-otp-btn" class="btn-login">Send Verification Code</button>
            
            <div id="verification-section" class="hidden" style="margin-top: 20px;">
                <div style="padding: 10px; background-color: #f9f9f9; border-left: 3px solid #3498db; margin-bottom: 15px;">
                    <p>A verification code has been sent to your phone. Enter it below:</p>
                </div>
                
                <div class="form-group">
                    <label for="verification-code">Verification Code</label>
                    <input type="text" id="verification-code" placeholder="123456" style="letter-spacing: 5px; font-size: 20px;" maxlength="6">
                    <div id="verification-error" style="color: #e74c3c; margin-top: 5px;"></div>
                </div>
                
                <button id="verify-otp-btn" class="btn-login">Verify Code</button>
            </div>
            
            <div id="status-container" style="margin-top: 15px;"></div>
            <div class="result" id="loginResult"></div>
        </div>
        
        <div class="card">
            <h2>Current User Test</h2>
            <button id="checkUserBtn" class="btn-login">Check Current User</button>
            <div class="result" id="userResult"></div>
        </div>
        
        <div class="card">
            <h2>LocalStorage Test</h2>
            <button id="checkStorageBtn">Check LocalStorage</button>
            <div class="result" id="storageResult"></div>
        </div>
        
        <div class="card">
            <h2>Navigation Test</h2>
            <button id="testMapBtn">Go to Map Page</button>
            <div class="result" id="navResult"></div>
        </div>
        
        <div class="card">
            <h2>Sign Out Test</h2>
            <button id="signOutBtn">Test Sign Out</button>
            <div class="result" id="signOutResult"></div>
        </div>
    </div>
    
    <script>
        // Create a mock Supabase client for development and testing
        function createMockClient() {
            console.log('Creating mock Supabase client for testing');
            
            return {
                auth: {
                    signInWithOtp: async ({ phone }) => {
                        console.log('Mock signInWithOtp called with phone:', phone);
                        
                        // Success only with test number
                        if (phone === '+12345678901') {
                            await new Promise(r => setTimeout(r, 800)); // Simulate network delay
                            return { 
                                data: { id: 'mock-session-id' }, 
                                error: null 
                            };
                        } else {
                            await new Promise(r => setTimeout(r, 1000)); // Slightly longer delay for errors
                            return {
                                data: null,
                                error: {
                                    message: 'Invalid phone number (mock). Use +12345678901 for testing.',
                                    status: 400
                                }
                            };
                        }
                    },
                    verifyOtp: async ({ phone, token }) => {
                        console.log('Mock verifyOtp called with:', { phone, token });
                        
                        // Success only with test number and code
                        if (phone === '+12345678901' && token === '123456') {
                            await new Promise(r => setTimeout(r, 1000)); // Simulate network delay
                            
                            // Generate realistic mock tokens
                            const mockAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IlRlc3QgVXNlciIsImlhdCI6MTUxNjIzOTAyMn0.mock-signature';
                            const mockRefreshToken = 'mock-refresh-token-' + Date.now();
                            
                            return {
                                data: {
                                    session: {
                                        access_token: mockAccessToken,
                                        refresh_token: mockRefreshToken,
                                        user: {
                                            id: 'mock-user-id-' + Date.now(),
                                            phone: phone,
                                            email: 'mock-user@example.com',
                                            user_metadata: {
                                                name: 'Mock Test User',
                                                avatar_url: 'https://ui-avatars.com/api/?name=Mock+User',
                                                provider: 'phone'
                                            },
                                            app_metadata: {
                                                provider: 'phone',
                                                providers: ['phone']
                                            },
                                            aud: 'authenticated',
                                            role: 'authenticated'
                                        },
                                        expires_at: Math.floor(Date.now() / 1000) + 3600 // 1 hour from now
                                    },
                                    user: {
                                        id: 'mock-user-id-' + Date.now(),
                                        phone: phone,
                                        email: 'mock-user@example.com',
                                        user_metadata: {
                                            name: 'Mock Test User',
                                            avatar_url: 'https://ui-avatars.com/api/?name=Mock+User',
                                            provider: 'phone'
                                        },
                                        app_metadata: {
                                            provider: 'phone',
                                            providers: ['phone']
                                        },
                                        aud: 'authenticated',
                                        role: 'authenticated'
                                    }
                                },
                                error: null
                            };
                        } else {
                            await new Promise(r => setTimeout(r, 800)); // Simulate network delay
                            return {
                                data: null,
                                error: {
                                    message: 'Invalid verification code or phone number (mock). Use +12345678901 and 123456.',
                                    status: 401
                                }
                            };
                        }
                    },
                    getUser: async () => {
                        console.log('Mock getUser called');
                        
                        return {
                            data: {
                                user: {
                                    id: 'mock-user-id-persistent',
                                    phone: '+12345678901',
                                    email: 'mock-test@example.com',
                                    user_metadata: {
                                        name: 'Mock Test User',
                                        avatar_url: 'https://ui-avatars.com/api/?name=Mock+User',
                                        provider: 'phone'
                                    },
                                    app_metadata: {
                                        provider: 'phone',
                                        providers: ['phone']
                                    }
                                }
                            },
                            error: null
                        };
                    },
                    signOut: async () => {
                        console.log('Mock signOut called');
                        return { error: null };
                    },
                    // Minimal implementation of other commonly used methods
                    onAuthStateChange: (callback) => {
                        console.log('Mock onAuthStateChange registered');
                        return { data: { subscription: { unsubscribe: () => {} } } };
                    }
                }
            };
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            // Handle configuration elements
            const supabaseUrlInput = document.getElementById('supabase-url');
            const supabaseKeyInput = document.getElementById('supabase-key');
            const saveConfigBtn = document.getElementById('save-config');
            const generateShareLinkBtn = document.getElementById('generate-share-link');
            const resetConfigBtn = document.getElementById('reset-config');
            const shareArea = document.querySelector('.share-area');
            const shareLinkInput = document.getElementById('share-link');
            const copyLinkBtn = document.getElementById('copy-link');
            
            // Display environment info
            const environmentInfo = document.getElementById('environmentInfo');
            environmentInfo.textContent = `isDevelopment: ${window.isDevelopment}\n`;
            environmentInfo.textContent += `Current hostname: ${window.location.hostname}`;
            
            // Phone OTP Authentication
            const phoneInput = document.getElementById('phoneNumber');
            const sendOtpBtn = document.getElementById('send-otp-btn');
            const verificationSection = document.getElementById('verification-section');
            const verificationInput = document.getElementById('verification-code');
            const verifyOtpBtn = document.getElementById('verify-otp-btn');
            const phoneError = document.getElementById('phone-error');
            const verificationError = document.getElementById('verification-error');
            const loginResult = document.getElementById('loginResult');
            const statusContainer = document.getElementById('status-container');
            
            // Show status message
            function showStatus(message, type = 'pending') {
                statusContainer.innerHTML = `<div class="status-indicator status-${type}">${message}</div>`;
            }
            
            // Validate phone number (basic validation)
            function validatePhone(phone) {
                // Allow international format or add + if not present
                if (!phone.startsWith('+')) {
                    return '+' + phone.replace(/\D/g, '');
                }
                return phone.replace(/\s/g, '');
            }
            
            // Send OTP handler
            sendOtpBtn.addEventListener('click', async () => {
                try {
                    phoneError.textContent = '';
                    loginResult.textContent = '';
                    
                    const rawPhone = phoneInput.value.trim();
                    if (!rawPhone) {
                        phoneError.textContent = 'Please enter a phone number';
                        return;
                    }
                    
                    const phoneNumber = validatePhone(rawPhone);
                    phoneInput.value = phoneNumber; // update with formatted number
                    
                    showStatus('Sending verification code...');
                    sendOtpBtn.disabled = true;
                    
                    // Send OTP via Supabase with fallback handling
                    try {
                        // Make sure Supabase client is available
                        if (!window.supabaseClient) {
                            throw new Error('Supabase client not initialized');
                        }
                        
                        const { error } = await window.supabaseClient.auth.signInWithOtp({
                            phone: phoneNumber
                        });
                        
                        if (error) throw error;
                        
                        // Show verification section
                        verificationSection.classList.remove('hidden');
                        showStatus('Verification code sent!', 'success');
                        verificationInput.focus();
                    } catch (error) {
                        console.warn('‚ùå OTP request error:', error);
                        showStatus(`Error: ${error.message}`, 'error');
                        sendOtpBtn.disabled = false;
                    }
                } catch (error) {
                    console.error('Error sending OTP:', error);
                    loginResult.textContent = 'Error: ' + error.message;
                    loginResult.classList.add('error');
                    sendOtpBtn.disabled = false;
                }
            });
            
            // Verify OTP handler
            verifyOtpBtn.addEventListener('click', async () => {
                try {
                    verificationError.textContent = '';
                    loginResult.textContent = '';
                    
                    const phoneNumber = phoneInput.value.trim();
                    const verificationCode = verificationInput.value.trim();
                    
                    if (!verificationCode) {
                        verificationError.textContent = 'Please enter the verification code';
                        return;
                    }
                    
                    showStatus('Verifying code...');
                    verifyOtpBtn.disabled = true;
                    
                    // Verify OTP with fallback handling
                    try {
                        // Verify OTP
                        const { data, error } = await window.supabaseClient.auth.verifyOtp({
                            phone: phoneNumber,
                            token: verificationCode,
                            type: 'sms'
                        });
                        
                        if (error) throw error;
                        
                        // SUCCESS: User authenticated
                        showStatus('Authentication successful!', 'success');
                        loginResult.textContent = 'Authentication successful! Redirecting...';
                        loginResult.classList.remove('error');
                        
                        // Save to session if appropriate
                        if (data.user && data.session) {
                            console.log('%c‚úÖ User authenticated!', 'color:green;font-weight:bold;font-size:14px');
                            
                            // Store session data multiple ways to ensure it persists
                            localStorage.setItem('sb-mock-auth-token', JSON.stringify(data.session));
                            sessionStorage.setItem('sb-mock-auth-token', JSON.stringify(data.session));
                            
                            // Store user data
                            localStorage.setItem('mockUser', JSON.stringify(data.user));
                            
                            // Set global flag to prevent redirects
                            window.__HAS_VALID_SESSION = true;
                            
                            // Create a global persisted flag
                            try {
                                document.cookie = 'trashdrop_auth_active=true; path=/; max-age=86400';
                            } catch (e) {}
                            
                            // Prepare redirect with forced auth
                            const forcedRedirect = () => {
                                const script = document.createElement('script');
                                script.textContent = `
                                    // Force flag in target page
                                    window.localStorage.setItem('sb-mock-auth-token', '${JSON.stringify(data.session)}');
                                    window.__HAS_VALID_SESSION = true;
                                    window.location.href = 'map.html';
                                `;
                                document.head.appendChild(script);
                            };
                            
                            // First attempt immediate redirect
                            setTimeout(forcedRedirect, 1500);
                        }
                    } catch (error) {
                        console.warn('‚ùå OTP verification error:', error);
                        showStatus(`Verification failed: ${error.message}`, 'error');
                        verifyOtpBtn.disabled = false;
                        verificationInput.focus();
                    }
                } catch (error) {
                    console.error('Error verifying OTP:', error);
                    loginResult.textContent = 'Error: ' + error.message;
                    loginResult.classList.add('error');
                    verifyOtpBtn.disabled = false;
                }
            });
            
            // Enter key for verification input
            verificationInput?.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    verifyOtpBtn.click();
                }
            });
            
            // Enter key for phone input
            phoneInput?.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    sendOtpBtn.click();
                }
            });
            
            // Load config from URL params, localStorage, or window.CONFIG
            function loadConfigValues() {
                // Get URL parameters first
                const urlParams = new URLSearchParams(window.location.search);
                const urlSupabaseUrl = urlParams.get('supabaseUrl');
                const urlSupabaseKey = urlParams.get('supabaseKey');
                
                // Get localStorage values
                const localSupabaseUrl = localStorage.getItem('supabase_url');
                const localSupabaseKey = localStorage.getItem('supabase_key');
                
                // Set input values from URL params if available, otherwise use localStorage
                if (urlSupabaseUrl) {
                    supabaseUrlInput.value = urlSupabaseUrl;
                } else if (localSupabaseUrl) {
                    supabaseUrlInput.value = localSupabaseUrl;
                } else if (window.CONFIG?.supabase?.url) {
                    supabaseUrlInput.value = window.CONFIG.supabase.url;
                }
                
                if (urlSupabaseKey) {
                    supabaseKeyInput.value = urlSupabaseKey;
                } else if (localSupabaseKey) {
                    supabaseKeyInput.value = localSupabaseKey;
                } else if (window.CONFIG?.supabase?.key) {
                    supabaseKeyInput.value = window.CONFIG.supabase.key;
                }
            }
            
            // Save configuration to localStorage
            saveConfigBtn.addEventListener('click', () => {
                const url = supabaseUrlInput.value.trim();
                const key = supabaseKeyInput.value.trim();
                
                if (!url || !key) {
                    alert('Please enter both Supabase URL and key');
                    return;
                }
                
                // Save to localStorage
                localStorage.setItem('supabase_url', url);
                localStorage.setItem('supabase_key', key);
                
                // Update CONFIG
                if (window.CONFIG) {
                    window.CONFIG.supabase.url = url;
                    window.CONFIG.supabase.key = key;
                    
                    if (window.SUPABASE_CONFIG) {
                        window.SUPABASE_CONFIG.url = url;
                        window.SUPABASE_CONFIG.key = key;
                    }
                }
                
                // Reinitialize client
                initializeSupabaseClient();
                
                alert('Configuration saved! Reloading authentication client...');
            });
            
            // Generate shareable link
            generateShareLinkBtn.addEventListener('click', () => {
                const url = supabaseUrlInput.value.trim();
                const key = supabaseKeyInput.value.trim();
                
                if (!url || !key) {
                    alert('Please enter both Supabase URL and key');
                    return;
                }
                
                // Create shareable URL with params
                const currentUrl = new URL(window.location.href);
                currentUrl.search = '';
                const shareableUrl = new URL(currentUrl);
                shareableUrl.searchParams.set('supabaseUrl', url);
                shareableUrl.searchParams.set('supabaseKey', key);
                
                // Display shareable link
                shareLinkInput.value = shareableUrl.href;
                shareArea.style.display = 'block';
            });
            
            // Copy link to clipboard
            copyLinkBtn.addEventListener('click', () => {
                shareLinkInput.select();
                document.execCommand('copy');
                copyLinkBtn.textContent = '‚úì Copied';
                setTimeout(() => {
                    copyLinkBtn.textContent = 'Copy';
                }, 2000);
            });
            
            // Reset to defaults
            resetConfigBtn.addEventListener('click', () => {
                // Remove from localStorage
                localStorage.removeItem('supabase_url');
                localStorage.removeItem('supabase_key');
                
                // Reset input values
                supabaseUrlInput.value = '';
                supabaseKeyInput.value = '';
                shareArea.style.display = 'none';
                
                // Reset CONFIG to original values
                if (window.CONFIG && window.CONFIG.supabase) {
                    const defaultUrl = 'https://npfpealzcpljpqiyyuut.supabase.co';
                    const defaultKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5wZnBlYWx6Y3BsanBxaXl5dXV0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDAwMDAwMDAsImV4cCI6MjAwMDAwMDAwMH0.qZSzcZA-5-ht9k-mWJIEIP5xyS1Wz-jLQK4RvMe24Mg';
                    
                    // Set defaults
                    window.CONFIG.supabase.url = defaultUrl;
                    window.CONFIG.supabase.key = defaultKey;
                    
                    if (window.SUPABASE_CONFIG) {
                        window.SUPABASE_CONFIG.url = defaultUrl;
                        window.SUPABASE_CONFIG.key = defaultKey;
                    }
                }
                
                alert('Configuration reset to defaults');
                initializeSupabaseClient();
            });
            
            // Load configuration initially
            loadConfigValues();
            
            // Load Supabase URL and key from window.CONFIG if available
            window.addEventListener('configLoaded', (event) => {
                console.log('Config loaded, initializing Supabase client...');
                loadConfigValues(); // Re-load values once config is ready
                initializeSupabaseClient();
            });
            
            // Initialize Supabase Client
            function initializeSupabaseClient() {
                try {
                    const url = supabaseUrlInput.value.trim();
                    const key = supabaseKeyInput.value.trim();
                    
                    // Update global configs to ensure consistency
                    if (window.CONFIG && window.CONFIG.supabase) {
                        window.CONFIG.supabase.url = url;
                        window.CONFIG.supabase.key = key;
                    }
                    
                    if (window.SUPABASE_CONFIG) {
                        window.SUPABASE_CONFIG.url = url;
                        window.SUPABASE_CONFIG.key = key;
                    }
                    
                    // Clear any previous client
                    window.supabaseClient = null;
                    
                    // Check if we need a mock client
                    const isDev = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                    const isValidUrl = url && url.includes('supabase.co');
                    const shouldUseMock = isDev || !isValidUrl;
                    
                    if (shouldUseMock) {
                        console.log('üì± Using mock Supabase client for development/testing');
                        window.supabaseClient = createMockClient();
                        const statusDiv = document.querySelector('.debug-info');
                        if (statusDiv) {
                            statusDiv.innerHTML = `<div style="padding: 10px; background-color: #fff3cd; border-left: 4px solid #ffc107; margin: 10px 0;">
                                <strong>‚ö†Ô∏è Using Mock Supabase Client</strong>
                                <p>The application is using a mock client because:</p>
                                <ul>
                                    <li>${isDev ? '‚úì' : '‚úó'} Running in development environment</li>
                                    <li>${!isValidUrl ? '‚úì' : '‚úó'} Invalid Supabase URL (must contain supabase.co)</li>
                                </ul>
                                <p>Test credentials will work: +12345678901 / 123456</p>
                            </div>`;
                        }
                    } else {
                        console.log('üîê Initializing real Supabase client with provided credentials');
                        // Initialize with the createClient method if available
                        if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
                            window.supabaseClient = supabase.createClient(url, key, {
                                persistSession: false // Disable session persistence for testing
                            });
                        } else {
                            // Fallback to direct constructor if needed
                            window.supabaseClient = new SupabaseClient(url, key, {
                                persistSession: false
                            });
                        }
                        
                        const statusDiv = document.querySelector('.debug-info');
                        if (statusDiv) {
                            statusDiv.innerHTML = `<div style="padding: 10px; background-color: #d4edda; border-left: 4px solid #28a745; margin: 10px 0;">
                                <strong>‚úÖ Using Real Supabase Client</strong>
                                <p>Connected to: ${url.substring(0, 30)}...</p>
                                <p>Use your actual phone number and the OTP code sent to it.</p>
                            </div>`;
                        }
                    }
                    
                    console.log('Supabase client initialized successfully');
                    return true;
                } catch (error) {
                    console.error('Error initializing Supabase client:', error);
                    const statusDiv = document.querySelector('.debug-info');
                    if (statusDiv) {
                        statusDiv.innerHTML = `<div style="padding: 10px; background-color: #f8d7da; border-left: 4px solid #dc3545; margin: 10px 0;">
                            <strong>‚ùå Error Initializing Supabase Client</strong>
                            <p>${error.message || 'Unknown error'}</p>
                        </div>`;
                    }
                    return false;
                }
            }
            
            // Test current user
            const checkUserBtn = document.getElementById('checkUserBtn');
            const userResult = document.getElementById('userResult');
            
            checkUserBtn.addEventListener('click', async () => {
                userResult.textContent = 'Checking...';
                
                try {
                    const user = await getCurrentUser();
                    userResult.textContent = user ? JSON.stringify(user, null, 2) : 'No user found';
                    userResult.classList.remove('error');
                } catch (error) {
                    userResult.textContent = 'Error: ' + error.message;
                    userResult.classList.add('error');
                }
            });
            
            // Test localStorage
            const checkStorageBtn = document.getElementById('checkStorageBtn');
            const storageResult = document.getElementById('storageResult');
            
            checkStorageBtn.addEventListener('click', () => {
                storageResult.textContent = 'LocalStorage contents:\n';
                
                try {
                    const mockUser = localStorage.getItem('mockUser');
                    storageResult.textContent += `mockUser: ${mockUser ? JSON.stringify(JSON.parse(mockUser), null, 2) : 'Not found'}\n\n`;
                    
                    // List all localStorage items
                    storageResult.textContent += 'All localStorage items:\n';
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        const value = localStorage.getItem(key);
                        storageResult.textContent += `${key}: ${value}\n`;
                    }
                    
                    storageResult.classList.remove('error');
                } catch (error) {
                    storageResult.textContent = 'Error: ' + error.message;
                    storageResult.classList.add('error');
                }
            });
            
            // Test navigation
            const testMapBtn = document.getElementById('testMapBtn');
            const navResult = document.getElementById('navResult');
            
            testMapBtn.addEventListener('click', () => {
                navResult.textContent = 'Navigating to map.html...';
                setTimeout(() => {
                    window.location.href = './map.html';
                }, 1000);
            });
            
            // Test sign out
            const signOutBtn = document.getElementById('signOutBtn');
            const signOutResult = document.getElementById('signOutResult');
            
            signOutBtn.addEventListener('click', async () => {
                signOutResult.textContent = 'Signing out...';
                
                try {
                    const result = await signOut();
                    signOutResult.textContent = JSON.stringify(result, null, 2);
                    signOutResult.classList.remove('error');
                } catch (error) {
                    signOutResult.textContent = 'Error: ' + error.message;
                    signOutResult.classList.add('error');
                }
            });
        });
    </script>
</body>
</html>
