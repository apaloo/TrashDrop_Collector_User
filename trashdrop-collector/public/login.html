<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In | TrashDrop Collector</title>
    <meta name="description" content="TrashDrop Collector App for waste management professionals">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    
    <!-- IMPORTANT: This page is a clean slate implementation specifically for testing the OTP flow -->
    <script>
        // Clear ALL storage on page load to ensure clean testing environment
        localStorage.clear();
        sessionStorage.clear();
        
        // Log clear confirmation
        console.log('üßπ All storage cleared for clean authentication testing');
    </script>
    
    <!-- Base styles only - no inherited styles that could cause issues -->
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #388E3C;
            --primary-light: #A5D6A7;
            --text-dark: #333333;
            --text-light: #666666;
            --border-radius: 24px;
            --input-radius: 50px;
            --card-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            --accent-color: #FF9800;
            --text-color: #333333;
            --text-light: #666666;
            --text-white: #FFFFFF;
            --error-color: #E53935;
            --border-color: #E0E0E0;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --input-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
        }

        body {
            font-family: 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
            color: var(--text-color);
            line-height: 1.6;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: linear-gradient(to bottom right, rgba(165, 214, 167, 0.2), rgba(255, 255, 255, 0));
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 4rem);
        }
        
        .login-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 2rem 3rem;
            width: 100%;
            max-width: 450px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        /* Decorative leaf background */
        .login-container::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -30px;
            width: 200px;
            height: 200px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path fill="%234CAF50" d="M20,80 Q40,60 60,80 T100,80 Q80,40 80,20 Q40,40 20,20 Q20,60 20,80 Z"/></svg>');
            background-repeat: no-repeat;
            background-size: contain;
            opacity: 0.2;
            z-index: 0;
            transform: rotate(45deg);
        }
        
        .header {
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
            border-radius: 50%;
            background-color: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.2);
        }
        
        .logo img {
            max-width: 100%;
            max-height: 100%;
        }
        
        h1 {
            color: var(--primary-color);
            margin: 0;
            font-size: 2.2rem;
            font-weight: 600;
            letter-spacing: -0.5px;
        }
        
        .subtitle {
            margin-top: 0.5rem;
            color: var(--text-light);
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        h2 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: var(--text-dark);
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        
        .auth-subtitle {
            color: var(--text-light);
            font-weight: normal;
            font-size: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        .auth-card {
            padding: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.8rem;
            text-align: left;
            position: relative;
            z-index: 1;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        input[type="text"],
        input[type="tel"],
        input[type="password"] {
            width: 100%;
            padding: 0.9rem 1.2rem;
            border: 1px solid #e0e0e0;
            border-radius: var(--input-radius);
            font-size: 1rem;
            box-sizing: border-box;
            transition: all 0.2s ease;
            background-color: #fcfcfc;
        }
        
        input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
            background-color: #fff;
        }
        
        input::placeholder {
            color: #aaa;
            font-size: 0.95rem;
        }
        
        .input-error {
            color: #f44336;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            margin-left: 0.2rem;
            font-weight: 500;
        }
        
        .form-text {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 0.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--input-radius);
            padding: 1rem 1.5rem;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: all 0.3s ease;
            display: inline-block;
            text-align: center;
            font-weight: 500;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 10px rgba(76, 175, 80, 0.3);
            position: relative;
            z-index: 1;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            transform: translateY(-1px);
        }
        
        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 1px 5px rgba(76, 175, 80, 0.3);
        }
        
        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .auth-links {
            margin-top: 1.8rem;
            font-size: 0.9rem;
            position: relative;
            z-index: 1;
        }
        
        .auth-links a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .auth-links a:hover {
            color: var(--primary-dark);
            text-decoration: none;
        }
        
        .divider {
            margin: 0 0.8rem;
            color: #ccc;
        }
        
        #phoneNumber, #verification-code {
            padding-left: 1.2rem;
            font-size: 1.05rem;
            letter-spacing: 0.5px;
        }
        
        /* Code input styling */
        #verification-code {
            letter-spacing: 3px;
            font-weight: 600;
            text-align: center;
        }
    </style>
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <!-- Clean, minimal script loading without auto-authentication -->
    <script>
        // Basic script loader
        function loadScript(src, onLoad) {
            return new Promise((resolve, reject) => {
                console.log('üì• Loading:', src);
                const script = document.createElement('script');
                script.src = src;
                script.onload = () => {
                    console.log('‚úÖ Loaded:', src);
                    if (onLoad) onLoad();
                    resolve();
                };
                script.onerror = (err) => {
                    console.error('‚ùå Error loading:', src, err);
                    reject(err);
                };
                document.head.appendChild(script);
            });
        }
        
        // Load required scripts in sequence
        async function loadAllScripts() {
            try {
                // 1. Load config first
                await loadScript('./src/js/config.js');
                
                // Set up Supabase config with proper URL formatting
                if (!window.CONFIG || !window.CONFIG.supabase) {
                    console.error('‚ùå Missing CONFIG or CONFIG.supabase');
                    window.CONFIG = window.CONFIG || {};
                    window.CONFIG.supabase = window.CONFIG.supabase || {
                        url: 'https://your-supabase-url.supabase.co',
                        key: 'your-supabase-anon-key'
                    };
                }
                
                // Setup a proper Supabase URL and set global development flag
                window.isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                console.log('üëâ Development mode set to:', window.isDevelopment);
                if (!window.CONFIG.supabase.url || 
                    window.CONFIG.supabase.url.includes('localhost:3000') || 
                    window.CONFIG.supabase.url === 'https://your-supabase-url.supabase.co') {
                    console.warn('‚ö†Ô∏è Using development mode with mock Supabase authentication');
                    
                    // Create mock Supabase methods for development/testing
                    window.useMockSupabase = true;
                    
                    // Still set a URL so the real client doesn't break completely
                    window.CONFIG.supabase.url = 'https://xyzsupabase.supabase.co';
                    window.CONFIG.supabase.key = 'mock-key-for-development-only';
                }
                
                window.SUPABASE_CONFIG = {
                    url: window.CONFIG.supabase.url,
                    key: window.CONFIG.supabase.key
                };
                
                // 2. Load Supabase client - try multiple sources to ensure it loads
                try {
                    // First try the same URL that the main app uses
                    await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js');
                } catch (e) {
                    console.warn('First Supabase load attempt failed, trying alternate CDN:', e);
                    // Fall back to the specific version
                    await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.4/dist/umd/supabase.min.js');
                }
                
                // Add extra debugging to see what's available
                console.log('Supabase library check:', {
                    'window.supabase': typeof window.supabase,
                    'window.supabase?.createClient': typeof window.supabase?.createClient
                });
                
                if (!window.supabase) {
                    throw new Error('Supabase library failed to load correctly');
                }
                
                // Add the debug div to the page to show the status
                const debugDiv = document.createElement('div');
                debugDiv.className = 'debug-info';
                debugDiv.style = 'padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; font-family: monospace;';
                document.body.appendChild(debugDiv);
                
                // Update debug div with library status
                debugDiv.innerHTML = `<p style="color:green">‚úÖ Supabase library loaded successfully</p>`;
                
                console.log('üîå Creating Supabase client');
                
                // Create client manually without relying on other scripts
                try {
                    // Debug info about the config
                    console.log('Supabase config check:', {
                        'URL available': !!window.SUPABASE_CONFIG.url,
                        'Key available': !!window.SUPABASE_CONFIG.key,
                        'URL length': window.SUPABASE_CONFIG.url?.length || 0,
                        'Key length': window.SUPABASE_CONFIG.key?.length || 0
                    });
                    
                    // Make sure we actually have required values
                    if (!window.SUPABASE_CONFIG.url || !window.SUPABASE_CONFIG.key) {
                        throw new Error('Missing Supabase URL or key in configuration');
                    }
                    
                    // Create client - either real or mock based on availability
                    if (window.useMockSupabase) {
                        console.log('‚ö†Ô∏è Creating mock Supabase client for offline testing');
                        
                        // Create a mock Supabase client with the required OTP methods
                        window.supabaseClient = {
                            auth: {
                                // Mock signInWithOtp that always succeeds
                                signInWithOtp: async function(options) {
                                    console.log('‚úÖ MOCK: Sending OTP to', options.phone);
                                    // Simulate network delay
                                    await new Promise(resolve => setTimeout(resolve, 800));
                                    return { data: {}, error: null };
                                },
                                
                                // Mock verifyOtp that always succeeds with test number +12345678901
                                verifyOtp: async function(options) {
                                    console.log('‚úÖ MOCK: Verifying OTP', options.token, 'for', options.phone);
                                    // Simulate network delay
                                    await new Promise(resolve => setTimeout(resolve, 800));
                                    
                                    // Simulate successful verification for test number or code 123456
                                    if (options.phone === '+12345678901' || options.token === '123456') {
                                        return {
                                            data: {
                                                user: {
                                                    id: 'test-user-id-123',
                                                    phone: options.phone,
                                                    user_metadata: { name: 'Test User' }
                                                },
                                                session: {
                                                    access_token: 'mock-token-' + Date.now(),
                                                    expires_at: Date.now() + 3600000,
                                                    refresh_token: 'mock-refresh-token'
                                                }
                                            },
                                            error: null
                                        };
                                    } else {
                                        // For any other phone number, simulate an error
                                        return {
                                            data: null,
                                            error: { message: 'Invalid verification code' }
                                        };
                                    }
                                },
                                
                                // Add other auth methods as needed
                                getUser: async function() {
                                    return {
                                        data: {
                                            user: {
                                                id: 'test-user-id-123',
                                                phone: '+12345678901',
                                                user_metadata: { name: 'Test User' }
                                            }
                                        },
                                        error: null
                                    };
                                }
                            }
                        };
                    } else {
                        // Create the real client
                        window.supabaseClient = window.supabase.createClient(
                            window.SUPABASE_CONFIG.url,
                            window.SUPABASE_CONFIG.key,
                            {
                                auth: {
                                    autoRefreshToken: true,
                                    persistSession: false // Don't persist session to avoid auto-login during testing
                                }
                            }
                        );
                    }
                    
                    // Verify client was created and has expected methods
                    if (!window.supabaseClient || !window.supabaseClient.auth) {
                        throw new Error('Supabase client created but missing expected properties');
                    }
                    
                    // Update debug div with client status
                    document.querySelector('.debug-info').innerHTML += 
                        `<p style="color:green">‚úÖ Supabase client initialized successfully</p>`;
                    
                    // Tell app the client is ready
                    window.dispatchEvent(new CustomEvent('supabaseClientReady'));
                    window.dispatchEvent(new CustomEvent('supabaseClientInitialized'));
                } catch (error) {
                    console.error('Failed to initialize Supabase client:', error);
                    document.querySelector('.debug-info').innerHTML += 
                        `<p style="color:red">‚ùå Supabase client initialization failed: ${error.message}</p>`;
                    throw error; // Re-throw so the outer catch can handle it properly
                }
                
                console.log('üî• All scripts loaded successfully!');
                
                // Safely handle DOM element references
                const loadingIndicator = document.querySelector('.loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                
                // The main authentication forms are directly in the cards, not in a separate auth-form element
                const phoneAuthSection = document.getElementById('phone-number-auth-section');
                if (phoneAuthSection) {
                    phoneAuthSection.classList.remove('hidden');
                }
            } catch (error) {
                console.error('‚ùå Script loading failed:', error);
                
                // Safely handle DOM element references in error case
                const loadingIndicator = document.querySelector('.loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.innerHTML = `<div class="status-error">Error loading resources: ${error.message}</div>`;
                } else {
                    // Create and show error message if the loading indicator doesn't exist
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'status-error';
                    errorDiv.innerText = `Error loading resources: ${error.message}`;
                    document.querySelector('.container')?.prepend(errorDiv);
                }
                
                // Show status message based on client type
                const devModeNotice = document.querySelector('.dev-mode-notice');
                if (devModeNotice) {
                    if (window.useMockSupabase) {
                        devModeNotice.classList.remove('hidden');
                    } else {
                        devModeNotice.classList.add('hidden');
                    }
                }
            }
        }
        
        // Authentication fallback for testing
        window.getCurrentUserFallback = function() {
            console.log('üì± Using fallback test user');
            return {
                id: 'test-user-id-' + new Date().getTime(),
                email: 'test@example.com',
                phone: '+12345678901',
                user_metadata: {
                    name: 'Test User',
                    role: 'collector'
                }
            };
        };
        
        // Get current user function with graceful fallback
        window.getCurrentUser = async function() {
            try {
                if (!window.supabaseClient) {
                    console.warn('‚ö†Ô∏è Supabase client not initialized, using fallback');
                    return window.getCurrentUserFallback();
                }
                
                const { data, error } = await window.supabaseClient.auth.getUser();
                
                if (error) {
                    console.warn('‚ö†Ô∏è Error getting user, using fallback:', error.message);
                    return window.getCurrentUserFallback();
                }
                
                if (!data || !data.user) {
                    console.warn('‚ö†Ô∏è No user data, using fallback');
                    return window.getCurrentUserFallback();
                }
                
                return data.user;
            } catch (error) {
                console.warn('‚ö†Ô∏è Exception getting user, using fallback:', error.message);
                return window.getCurrentUserFallback();
            }
        };
        
        // Start loading on page load
        window.addEventListener('DOMContentLoaded', loadAllScripts);
    </script>
    
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            width: 100%;
            transition: background-color 0.3s ease, transform 0.1s ease;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-primary:active {
            transform: translateY(1px);
        }
        
        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .info-box {
            padding: 12px 15px;
            background-color: rgba(52, 152, 219, 0.1);
            border-left: 3px solid #3498db;
            margin-bottom: 20px;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .hidden {
            display: none;
        }
        
        #verification-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }
        
        #verification-code {
            letter-spacing: 5px;
            font-size: 20px;
            text-align: center;
        }
        
        .auth-links {
            margin-top: 25px;
            text-align: center;
            font-size: 14px;
        }
        
        .auth-links a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color 0.2s ease;
        }
        
        .auth-links a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        .divider {
            margin: 0 10px;
            color: var(--text-light);
        }
        
        #status-container {
            margin-top: 15px;
            min-height: 20px;
        }
        
        .dev-mode-notice {
            margin-top: 20px;
            padding: 10px;
            background-color: #fff9e6;
            border-radius: 4px;
            font-size: 13px;
            color: #b38a00;
            text-align: center;
        }
        
        .dev-mode-notice code {
            background: rgba(0,0,0,0.05);
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        .supabase-config {
            display: none;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
        }
        input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button:hover {
            background: var(--primary-dark);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-primary {
            background: var(--primary-color);
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: var(--secondary-color);
        }
        
        .btn-secondary:hover {
            background: var(--secondary-dark);
        }
        
        .btn-full {
            width: 100%;
            margin: 10px 0;
        }
        
        .btn-login {
            width: 100%;
            background: var(--secondary-color);
            margin: 15px 0;
            padding: 12px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .btn-login:hover {
            background: var(--secondary-dark);
        }
        .forgot-password, .signup-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #2196F3;
            text-decoration: none;
        }
        .forgot-password:hover, .signup-link:hover {
            text-decoration: underline;
        }
        .auth-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }
        .result {
            background: #f1f1f1;
            padding: 1rem;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .error {
            color: red;
        }
        
        .status-indicator {
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 10px;
            display: inline-block;
        }
        
        .status-pending {
            background-color: #f39c12;
            color: white;
        }
        
        .status-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .status-error {
            background-color: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="login-container">
            <div class="header">
                <div class="logo">
                    <img src="src/img/logo.png" alt="TrashDrop Logo" onerror="this.src='https://ui-avatars.com/api/?name=Trash+Drop&background=4CAF50&color=fff&size=128&bold=true'">
                </div>
                <h1>TrashDrop</h1>
                <p class="subtitle">Collector Login</p>
            </div>
            
            <!-- Hidden debug info for technical troubleshooting -->
            <div class="debug-info" style="display: none;"></div>
            <div id="environmentInfo" style="display: none;" class="debug-info"></div>
            
            <!-- Status indicator -->
            <div class="status-container">
                <div class="loading-indicator" style="display: none;">Loading authentication resources...</div>
            </div>
        
            <!-- Hidden configuration inputs for shareable URLs -->
        <div class="supabase-config" style="display: none;">
            <input type="text" id="supabase-url">
            <input type="text" id="supabase-key">
        </div>
        
        <!-- Phone Number Authentication -->
        <div class="auth-card" id="phone-number-auth-section">
            <h2>Sign In</h2>
            <p class="auth-subtitle">Enter your phone number to receive a verification code</p>
            <div class="form-group">
                <label for="phoneNumber">Phone Number</label>
                <input type="tel" id="phoneNumber" placeholder="+1 (555) 555-5555">
                <div id="phone-error" class="input-error"></div>
            </div>
            <button id="send-otp-btn" class="btn-primary" type="button" onclick="handleSendOTP(event)">Send Verification Code</button>
            
            <div id="verification-section" class="hidden">
                <div class="info-box">
                    <p>A verification code has been sent to your phone.</p>
                </div>
                
                <div class="form-group">
                    <label for="verification-code">Verification Code</label>
                    <input type="text" id="verification-code" placeholder="Enter 6-digit code" maxlength="6">
                    <div id="verification-error" class="input-error"></div>
                </div>
                
                <button id="verify-otp-btn" class="btn-primary" type="button" onclick="handleVerifyOTP(event)">Sign In</button>
            </div>
            
            <div id="status-container"></div>
            <div class="dev-mode-notice hidden"></div>
            <div class="result hidden" id="loginResult"></div>
            
            <div class="auth-links">
                <a href="signup.html" class="link-signup">Create Account</a>
            </div>
            
            <!-- Dev mode notice only shown when needed -->
            <div class="dev-mode-notice hidden">
                <p><strong>Development Mode:</strong> Use phone <code>+12345678901</code> and code <code>123456</code></p>
            </div>
        </div>
        
        <!-- Hidden test elements to maintain script compatibility -->
        <div style="display:none">
            <button id="checkUserBtn"></button>
            <div id="userResult"></div>
            <button id="getStorageBtn"></button>
            <button id="clearStorageBtn"></button>
            <button id="checkStorageBtn"></button>
            <div id="storageResult"></div>
            <button id="testMapBtn"></button>
            <div id="navResult"></div>
            <button id="signOutBtn"></button>
            <div id="signOutResult"></div>
        </div>
    </div>
    
    <script>
        // Set development mode flag for easier testing
        window.isDevelopment = true;
        
        // Create a mock Supabase client for development and testing
        function createMockClient() {
            console.log('Creating mock Supabase client for testing');
            
            return {
                auth: {
                    signInWithOtp: async ({ phone }) => {
                        console.log('Mock signInWithOtp called with phone:', phone);
                        
                        // Success only with test number
                        if (phone === '+12345678901') {
                            await new Promise(r => setTimeout(r, 800)); // Simulate network delay
                            return { 
                                data: { id: 'mock-session-id' }, 
                                error: null 
                            };
                        } else {
                            await new Promise(r => setTimeout(r, 1000)); // Slightly longer delay for errors
                            return {
                                data: null,
                                error: {
                                    message: 'Invalid phone number (mock). Use +12345678901 for testing.',
                                    status: 400
                                }
                            };
                        }
                    },
                    verifyOtp: async ({ phone, token }) => {
                        console.log('Mock verifyOtp called with:', { phone, token });
                        
                        // Success only with test number and code
                        if (phone === '+12345678901' && token === '123456') {
                            await new Promise(r => setTimeout(r, 1000)); // Simulate network delay
                            
                            // Generate realistic mock tokens
                            const mockAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IlRlc3QgVXNlciIsImlhdCI6MTUxNjIzOTAyMn0.mock-signature';
                            const mockRefreshToken = 'mock-refresh-token-' + Date.now();
                            
                            return {
                                data: {
                                    session: {
                                        access_token: mockAccessToken,
                                        refresh_token: mockRefreshToken,
                                        user: {
                                            id: 'mock-user-id-' + Date.now(),
                                            phone: phone,
                                            email: 'mock-user@example.com',
                                            user_metadata: {
                                                name: 'Mock Test User',
                                                avatar_url: 'https://ui-avatars.com/api/?name=Mock+User',
                                                provider: 'phone'
                                            },
                                            app_metadata: {
                                                provider: 'phone',
                                                providers: ['phone']
                                            },
                                            aud: 'authenticated',
                                            role: 'authenticated'
                                        },
                                        expires_at: Math.floor(Date.now() / 1000) + 3600 // 1 hour from now
                                    },
                                    user: {
                                        id: 'mock-user-id-' + Date.now(),
                                        phone: phone,
                                        email: 'mock-user@example.com',
                                        user_metadata: {
                                            name: 'Mock Test User',
                                            avatar_url: 'https://ui-avatars.com/api/?name=Mock+User',
                                            provider: 'phone'
                                        },
                                        app_metadata: {
                                            provider: 'phone',
                                            providers: ['phone']
                                        },
                                        aud: 'authenticated',
                                        role: 'authenticated'
                                    }
                                },
                                error: null
                            };
                        } else {
                            await new Promise(r => setTimeout(r, 800)); // Simulate network delay
                            return {
                                data: null,
                                error: {
                                    message: 'Invalid verification code or phone number (mock). Use +12345678901 and 123456.',
                                    status: 401
                                }
                            };
                        }
                    },
                    getUser: async () => {
                        console.log('Mock getUser called');
                        
                        return {
                            data: {
                                user: {
                                    id: 'mock-user-id-persistent',
                                    phone: '+12345678901',
                                    email: 'mock-test@example.com',
                                    user_metadata: {
                                        name: 'Mock Test User',
                                        avatar_url: 'https://ui-avatars.com/api/?name=Mock+User',
                                        provider: 'phone'
                                    },
                                    app_metadata: {
                                        provider: 'phone',
                                        providers: ['phone']
                                    }
                                }
                            },
                            error: null
                        };
                    },
                    signOut: async () => {
                        console.log('Mock signOut called');
                        return { error: null };
                    },
                    // Minimal implementation of other commonly used methods
                    onAuthStateChange: (callback) => {
                        console.log('Mock onAuthStateChange registered');
                        return { data: { subscription: { unsubscribe: () => {} } } };
                    }
                }
            };
        }
        

</script>
</body>
</html>
// Function to handle sending OTP verification code
function handleSendOTP(event) {
    event.preventDefault();
    console.log('Send OTP button clicked');
    
    const phoneInput = document.getElementById('phoneNumber');
    const phoneError = document.getElementById('phone-error');
    const verificationSection = document.getElementById('verification-section');
    const statusContainer = document.getElementById('status-container');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    
    // Clear previous errors
    if (phoneError) phoneError.textContent = '';
    
    try {
        // Get and validate phone number
        const rawPhone = phoneInput ? phoneInput.value.trim() : '';
        if (!rawPhone) {
            if (phoneError) phoneError.textContent = 'Please enter a phone number';
            return;
        }
        
        // Simple validation - add + if not present
        const phoneNumber = !rawPhone.startsWith('+') ? 
            '+' + rawPhone.replace(/\D/g, '') : 
            rawPhone.replace(/\s/g, '');
        if (phoneInput) phoneInput.value = phoneNumber; // update with formatted number
        
        // Show status indicator
        showStatus('Sending verification code...', 'pending');
        
        // Disable button while processing
        if (sendOtpBtn) sendOtpBtn.disabled = true;
        
        // Development mode handling
        if (window.isDevelopment) {
            console.log('üí° Development mode: Mock sending verification code to', phoneNumber);
            
            // Show development mode notice with test instructions
            const devModeNotice = document.querySelector('.dev-mode-notice');
            if (devModeNotice) {
                devModeNotice.innerHTML = `
                    <strong>Development Mode</strong>
                    <p>Test phone: <code>+12345678901</code></p>
                    <p>Test code: <code>123456</code></p>
                `;
                devModeNotice.classList.remove('hidden');
            }
            
            // Show verification section
            if (verificationSection) {
                verificationSection.classList.remove('hidden');
                showStatus('Verification code sent! (MOCK MODE)', 'success');
                
                // Focus on verification input
                const verificationInput = document.getElementById('verification-code');
                if (verificationInput) verificationInput.focus();
            } else {
                console.error('Verification section not found!');
            }
            
            // Re-enable the button after a delay
            setTimeout(() => {
                if (sendOtpBtn) sendOtpBtn.disabled = false;
            }, 2000);
            
        } else {
            // Real Supabase implementation
            const supabase = window.supabaseClient;
            if (!supabase) {
                throw new Error('Supabase client not initialized');
            }
            
            // Call signInWithOtp with phone number
            supabase.auth.signInWithOtp({
                phone: phoneNumber
            }).then(({ error }) => {
                if (error) throw error;
                
                // Show verification section on success
                if (verificationSection) {
                    verificationSection.classList.remove('hidden');
                    showStatus('Verification code sent!', 'success');
                    
                    // Focus on verification input
                    const verificationInput = document.getElementById('verification-code');
                    if (verificationInput) verificationInput.focus();
                }
                
                // Re-enable button
                if (sendOtpBtn) sendOtpBtn.disabled = false;
            }).catch(error => {
                console.warn('‚úñ OTP request error:', error);
                showStatus(`Error: ${error.message}`, 'error');
                if (sendOtpBtn) sendOtpBtn.disabled = false;
            });
        }
    } catch (error) {
        console.error('Error sending OTP:', error);
        showStatus('Error: ' + (error.message || 'Failed to send code'), 'error');
        
        // Re-enable the button
        if (sendOtpBtn) sendOtpBtn.disabled = false;
    }
}

// Function to handle OTP verification
function handleVerifyOTP(event) {
    event.preventDefault();
    console.log('Verify OTP button clicked');
    
    const verificationCode = document.getElementById('verification-code');
    const verificationError = document.getElementById('verification-error');
    const verifyOtpBtn = document.getElementById('verify-otp-btn');
    
    // Clear previous errors
    if (verificationError) verificationError.textContent = '';
    
    try {
        // Get and validate OTP code
        const otpCode = verificationCode ? verificationCode.value.trim() : '';
        if (!otpCode) {
            if (verificationError) verificationError.textContent = 'Please enter the verification code';
            return;
        }
        
        // Show status indicator
        showStatus('Verifying code...', 'pending');
        
        // Disable button while processing
        if (verifyOtpBtn) verifyOtpBtn.disabled = true;
        
        // Development mode handling
        if (window.isDevelopment) {
            console.log('üí° Development mode: Mock verifying OTP code');
            
            // Check if using test credentials
            const phoneInput = document.getElementById('phoneNumber');
            const phoneNumber = phoneInput ? phoneInput.value.trim() : '';
            
            if (phoneNumber === '+12345678901' && otpCode === '123456') {
                console.log('Test credentials verified successfully!');
                showStatus('Verification successful!', 'success');
                
                // Set demo user in session for fallback auth
                const mockUser = {
                    id: 'mock-user-id',
                    phone: phoneNumber,
                    user_metadata: { phone: phoneNumber }
                };
                localStorage.setItem('supabase.auth.token', JSON.stringify({
                    access_token: 'mock-token',
                    expires_at: Date.now() + 3600000,
                    user: mockUser
                }));
                
                // Mock successful authentication
                setTimeout(() => {
                    window.location.href = './index.html';
                }, 1000);
            } else {
                console.log('Invalid test credentials');
                showStatus('Invalid verification code', 'error');
                if (verifyOtpBtn) verifyOtpBtn.disabled = false;
            }
        } else {
            // Real Supabase implementation
            const supabase = window.supabaseClient;
            if (!supabase) {
                throw new Error('Supabase client not initialized');
            }
            
            // Verify OTP with Supabase
            supabase.auth.verifyOtp({
                phone: document.getElementById('phoneNumber').value.trim(),
                token: otpCode,
                type: 'sms'
            }).then(({ error }) => {
                if (error) throw error;
                
                showStatus('Authentication successful!', 'success');
                setTimeout(() => window.location.href = './index.html', 1000);
            }).catch(error => {
                console.error('Verification error:', error);
                showStatus('Error: ' + (error.message || 'Verification failed'), 'error');
                if (verifyOtpBtn) verifyOtpBtn.disabled = false;
            });
        }
    } catch (error) {
        console.error('Error verifying OTP:', error);
        showStatus('Error: ' + (error.message || 'Failed to verify code'), 'error');
        
        // Re-enable the button
        if (verifyOtpBtn) verifyOtpBtn.disabled = false;
    }
}

// Helper function to show status messages
function showStatus(message, type = 'pending') {
    const statusContainer = document.getElementById('status-container');
    if (statusContainer) {
        statusContainer.innerHTML = `<div class="status-indicator status-${type}">${message}</div>`;
    } else {
        console.warn('Status container not found, message:', message);
    }
}

// Current user fallback for testing
function getCurrentUserFallback() {
    return {
        id: 'demo-user-id',
        email: 'demo@example.com',
        phone: '+12345678901',
        user_metadata: {
            phone: '+12345678901',
            name: 'Demo User'
        }
    };
}

// Initialize authentication components
document.addEventListener('DOMContentLoaded', () => {
    // Make fallback available globally
    window.getCurrentUserFallback = getCurrentUserFallback;
    
    // Set up event handlers for OTP buttons
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const verifyOtpBtn = document.getElementById('verify-otp-btn');
    
    // Attach event handlers directly to buttons
    if (sendOtpBtn) {
        sendOtpBtn.onclick = handleSendOTP;
    }
    
    if (verifyOtpBtn) {
        verifyOtpBtn.onclick = handleVerifyOTP;
    }
    
    // Set up enter key handling for inputs
    const phoneInput = document.getElementById('phoneNumber');
    const verificationInput = document.getElementById('verification-code');
    
    if (phoneInput) {
        phoneInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter' && sendOtpBtn) {
                handleSendOTP(event);
            }
        });
    }
    
    if (verificationInput) {
        verificationInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter' && verifyOtpBtn) {
                handleVerifyOTP(event);
            }
        });
    }
    
    // Remove "Forgot Password" button/functionality
    const forgotPasswordLink = document.querySelector('.forgot-password');
    if (forgotPasswordLink) {
        forgotPasswordLink.style.display = 'none';
    }
});
</script></body></html>
